<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººå¥åº·è³‡æ–™ç®¡ç†</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
         /* å·²è®€æŒ‰éˆ•ç¾åŒ– */
.mark-read-btn {
    background: #27ae60; /* ç¶ è‰²è¡¨ç¤ºå·²è®€ */
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-left: 10px;
}

.mark-read-btn:hover {
    background: #219653;
    transform: translateY(-2px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

.mark-read-btn:active {
    transform: translateY(0);
    box-shadow: none;
}

/* è®“é€šçŸ¥ item èˆ‡æŒ‰éˆ•åœ¨åŒä¸€è¡Œæ’åˆ— */
.communication-item .comm-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.communication-item .comm-header .mark-read-btn {
    margin-left: 0;
}

        .header {
            background: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .user-info {
            background: #34495e;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .user-actions {
            display: flex;
            gap: 15px;
        }

        .action-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .action-btn:hover {
            background: #2980b9;
        }

        .content-section {
            padding: 30px;
        }

        .section-title {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 25px;
            font-size: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-group {
            margin-bottom: 20px;
        }

        .info-label {
            font-weight: 600;
            color: #34495e;
            margin-bottom: 5px;
        }

        .info-value {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .empty-value {
            color: #7f8c8d;
            font-style: italic;
        }

        .form-section {
            padding: 30px;
            display: none;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-option input {
            width: auto;
        }

        .required::after {
            content: " *";
            color: #e74c3c;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #219653;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-info {
            background: #17a2b8;
        }

        .btn-info:hover {
            background: #138496;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .action-buttons .btn {
            width: auto;
            flex: 1;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .info-text {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* é€šçŸ¥è¨˜éŒ„æ¨£å¼ */
        .communication-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .communication-item:hover {
            background: #e3f2fd;
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .comm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }

        .comm-category {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .comm-date {
            color: #6c757d;
            font-size: 12px;
        }

        .comm-content {
            color: #2c3e50;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .comm-sender {
            color: #7f8c8d;
            font-size: 12px;
            text-align: right;
        }

        .comm-status-active {
            border-left: 4px solid #27ae60;
        }

        .comm-status-completed {
            border-left: 4px solid #3498db;
        }

        .comm-status-other {
            border-left: 4px solid #95a5a6;
        }

        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 15px;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        .comm-priority-urgent {
            background: #fff3cd;
            border-color: #ffeaa7;
        }

        .comm-priority-urgent .comm-category {
            background: #e74c3c;
        }
        
        /* æ¨¡æ…‹æ¡†æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .user-info {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .user-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘¤ å€‹äººè³‡æ–™ç®¡ç†</h1>
            <p>ç®¡ç†æ‚¨çš„å€‹äººåŸºæœ¬è³‡æ–™</p>
        </div>

        <div class="user-info">
            <div class="user-actions">
                <button class="action-btn" onclick="switchToViewMode()">ğŸ“‹ æª¢è¦–è³‡æ–™</button>
                <button class="action-btn" onclick="switchToEditMode()">âœï¸ ç·¨è¼¯è³‡æ–™</button>
            </div>
        </div>
           
        <!-- æª¢è¦–æ¨¡å¼ -->
        <div class="content-section" id="viewMode">
            <div id="alertMessage" class="alert"></div>

            <h2 class="section-title">ğŸ“‹ å€‹äººè³‡æ–™ç¸½è¦½</h2>
            
            <div class="info-grid">
                <!-- å¸³æˆ¶è³‡æ–™ -->
                <div>
                    <h3 class="section-title">ğŸ‘¤ å¸³æˆ¶è³‡æ–™ (ä¾†è‡ª Person)</h3>
                    <div class="info-group">
                        <div class="info-label">å§“å</div>
                        <div class="info-value" id="view-name">è¼‰å…¥ä¸­...</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">é›»å­éƒµä»¶</div>
                        <div class="info-value" id="view-email">è¼‰å…¥ä¸­...</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">ä½¿ç”¨è€… ID</div>
                        <div class="info-value" id="view-personId">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
                <!-- å€‹äººå¥åº·è³‡æ–™ -->
                <div>
                    <h3 class="section-title">ğŸ“ å€‹äººå¥åº·è³‡æ–™</h3>
                    <div class="info-group">
                        <div class="info-label">å‡ºç”Ÿæ—¥æœŸ</div>
                        <div class="info-value empty-value" id="view-birthDate">å°šæœªå¡«å¯«</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">æ€§åˆ¥</div>
                        <div class="info-value empty-value" id="view-gender">å°šæœªå¡«å¯«</div>
                    </div>
                </div>
            </div>

            <div class="info-grid">
                <!-- è¯çµ¡è³‡è¨Š -->
              <div>
                  <h3 class="section-title">ğŸ“ è¯çµ¡è³‡è¨Š</h3>
                   <div class="info-group">
                      <div class="info-label">æ‰‹æ©Ÿè™Ÿç¢¼</div>
                       <div class="info-value empty-value" id="view-phone">å°šæœªå¡«å¯«</div>
                  </div>
                   <div class="info-group">
                     <div class="info-label">å®¶ä¸­åœ°å€</div>
                     <div class="info-value empty-value" id="view-address">å°šæœªå¡«å¯«</div>
                  </div>
                 <div class="info-group">
                  <div class="info-label">ç¤¾å€å°å•†åº—åœ°å€</div>
                  <div class="info-value empty-value" id="view-communityAddress">å°šæœªå¡«å¯«</div>
                </div>
           </div>
                
                <!-- é€šçŸ¥è¨˜éŒ„ -->
                <div>
                    <h3 class="section-title">ğŸ“¢ æœ€æ–°é€šçŸ¥è¨˜éŒ„</h3>
                    <button class="refresh-btn" onclick="refreshCommunications()">ğŸ”„ é‡æ–°æ•´ç†é€šçŸ¥</button>
                    <div id="communications-container">
                        <div class="info-value empty-value" id="no-communications">è¼‰å…¥ä¸­...</div>
                        <div id="communications-list" style="display: none;">
                            <!-- é€šçŸ¥åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- åŠŸèƒ½æŒ‰éˆ• -->
            <div class="action-buttons">
                <button class="btn btn-warning" onclick="goBack()">â¬…ï¸ è¿”å›é¦–é </button>
                <button class="btn btn-success" onclick="applyMedicineDelivery()">ç”³è«‹é…é€è—¥å“åˆ°å®¶</button>
                <button class="btn btn-info" onclick="showOrganizationLink()">ğŸ¥ é€£çµé†«ç™‚æ©Ÿæ§‹</button>
            </div>
        </div>

        <!-- ç·¨è¼¯æ¨¡å¼ -->
        <div class="form-section" id="editMode">
            <div id="editAlertMessage" class="alert"></div>

            <form id="patientForm">
                <!-- åŸºæœ¬è³‡æ–™ -->
                <h2 class="section-title">ğŸ“ åŸºæœ¬è³‡æ–™</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="name" class="required">ä¸­æ–‡å§“å</label>
                        <input type="text" id="name" name="name" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å" required>
                    </div>
            
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="birthDate" class="required">å‡ºç”Ÿæ—¥æœŸ</label>
                        <input type="date" id="birthDate" name="birthDate" required max="">
                    </div>
                    <div class="form-group">
                        <label class="required">æ€§åˆ¥</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="gender" value="male" required> ç”·æ€§
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="gender" value="female"> å¥³æ€§
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="gender" value="other"> å…¶ä»–
                            </label>
                        </div>
                    </div>
                </div>

                <!-- è¯çµ¡è³‡è¨Š -->
                <h2 class="section-title">ğŸ“ è¯çµ¡è³‡è¨Š</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="phone" class="required">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                        <input type="tel" id="phone" name="phone" placeholder="0912-345-678" required>
                    </div>
                </div>

                <!-- åœ°å€ -->
                <div class="form-group">
                       <label for="address" class="required">å®¶ä¸­åœ°å€</label>
                      <input type="text" id="address" name="address" placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€" required>
                </div>

                 <div class="form-group">
                <label for="communityAddress">ç¤¾å€å°å•†åº—åœ°å€</label>
                <select id="communityAddress">
                    <option value="org.id">è«‹é¸æ“‡ç¤¾å€å°å•†åº—</option>
               </select>
                 </div>
                <!-- æŒ‰éˆ• -->
                <button type="submit" class="btn">ğŸ’¾ å„²å­˜å€‹äººè³‡æ–™</button>
                <button type="button" class="btn btn-secondary" onclick="switchToViewMode()">è¿”å›æª¢è¦–æ¨¡å¼</button>
                
                <!-- åŠŸèƒ½æŒ‰éˆ• -->
                <div class="action-buttons">
                    <button type="button" class="btn btn-warning" onclick="goBack()">â¬…ï¸ è¿”å›é¦–é </button>
                    <button type="button" class="btn btn-success" onclick="applyMedicineDelivery()">ç”³è«‹é…é€è—¥å“åˆ°å®¶</button>
                    <button type="button" class="btn btn-info" onclick="showOrganizationLink()">ğŸ¥ é€£çµé†«ç™‚æ©Ÿæ§‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- çµ„ç¹”é€£çµæ¨¡æ…‹æ¡† -->
    <div id="organizationModal" class="modal">
        <div class="modal-content">
            <h2>ğŸ¥ é€£çµé†«ç™‚æ©Ÿæ§‹</h2>
            
            <div id="syncStatus" class="alert" style="display: none;"></div>
            
            <div class="form-group">
                <label>é¸æ“‡é†«ç™‚æ©Ÿæ§‹</label>
                <select id="organizationSelect" class="form-control" style="width: 100%; padding: 10px; margin-bottom: 15px;">
                    <option value="">è¼‰å…¥ä¸­...</option>
                </select>
            </div>
            
          
            
            <div class="action-buttons">
                <button class="btn btn-success" onclick="syncPatientToOrganization()">âœ… ç¢ºèªé€£çµ</button>
                <button class="btn btn-secondary" onclick="hideOrganizationModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

   <script>
const FHIR_BASE_URL = "http://203.64.84.204:8080/fhir"; // â† æ”¹æˆä½ çš„ FHIR Server
let currentPersonId = null;
let currentPatientId = null;
let currentPersonEmail = null;
document.addEventListener("DOMContentLoaded", async () => {
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("birthDate").setAttribute("max", today);
    await loadUserData();
      await loadCommunityStores();
    // ç¶å®šè¡¨å–®æäº¤äº‹ä»¶
    const form = document.getElementById("patientForm");
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        await savePatientData();
    });
});
function goBack() {
    window.location.href="/patient-register.html";
}

// 1ï¸âƒ£ è¼‰å…¥ Person è³‡æ–™
async function loadUserData() {
    try {
        const res = await fetch("/api/person", { credentials: "include" });
        if (!res.ok) throw new Error("ç„¡æ³•å–å¾—ç™»å…¥ä½¿ç”¨è€…è³‡è¨Š");
        const user = await res.json();
        currentPersonId = user.personId;

        const personRes = await fetch(`${FHIR_BASE_URL}/Person/${currentPersonId}`);
        const person = await personRes.json();

        // æ›´æ–°å‰ç«¯å¸³æˆ¶è³‡æ–™
        const displayName = person.name?.[0]?.text ?? "ï¼ˆæœªå¡«å¯«å§“åï¼‰";
        document.getElementById("view-name").innerText = displayName;
        document.getElementById("view-email").innerText =
            person.telecom?.find(t => t.system === "email")?.value ?? "æœªå¡«å¯«";
        document.getElementById("view-personId").innerText = currentPersonId;

        // æª¢æŸ¥ Person.link æ˜¯å¦å·²æœ‰ Patient
        const link = person.link?.find(l => l.target.reference.startsWith("Patient/"));
        currentPatientId = link ? link.target.reference.split("/")[1] : null;
         currentPersonEmail = person.telecom?.find(t => t.system === "email")?.value ?? "";

        // å¦‚æœæœ‰ Patientï¼Œè¼‰å…¥ Patient è³‡æ–™
        if (currentPatientId) await loadPatientData(currentPatientId);

        // å¡«å…¥ç·¨è¼¯è¡¨å–®åˆå§‹å€¼
        document.getElementById("name").value = displayName;
        if (currentPatientId) {
            const patientRes = await fetch(`${FHIR_BASE_URL}/Patient/${currentPatientId}`);
            const patient = await patientRes.json();
            document.getElementById("birthDate").value = patient.birthDate ?? "";
            if (patient.gender) document.querySelector(`input[name="gender"][value="${patient.gender}"]`).checked = true;
            document.getElementById("phone").value = patient.telecom?.find(t => t.system === "phone")?.value ?? "";
            document.getElementById("address").value = patient.address?.[0]?.text ?? "";
        }
       if (currentPatientId) {
    await refreshCommunications(); // è¼‰å…¥å®Œæˆ Patient å¾Œåˆ·æ–°é€šçŸ¥
}
    } catch (err) {
        console.error("âŒ è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—ï¼š", err);
    }
}

// 2ï¸âƒ£ è¼‰å…¥ Patient è³‡æ–™åˆ°æª¢è¦–å€å¡Š
async function loadPatientData(patientId) {
    try {
        const res = await fetch(`${FHIR_BASE_URL}/Patient/${patientId}`);
        if (!res.ok) throw new Error("ç„¡æ³•å–å¾— Patient è³‡æ–™");
        const patient = await res.json();

        // === åŸºæœ¬æ¬„ä½ ===
        document.getElementById("view-birthDate").innerText = patient.birthDate ?? "å°šæœªå¡«å¯«";
        document.getElementById("view-gender").innerText = patient.gender ?? "å°šæœªå¡«å¯«";
        document.getElementById("view-phone").innerText = 
            patient.telecom?.find(t => t.system === "phone")?.value ?? "å°šæœªå¡«å¯«";

        document.getElementById("view-address").innerText =
            patient.address?.find(a => a.use === "home")?.text ?? "å°šæœªå¡«å¯«";

        // === å–å¾— Community Store Organization ID ===
        const communityOrgRef = patient.contact?.[0]?.organization?.reference;  
        // e.g. "Organization/2199"

        let communityStoreText = "å°šæœªé¸æ“‡";

        if (communityOrgRef) {
            const orgId = communityOrgRef.replace("Organization/", "");
            // æŸ¥ Organization
            const orgRes = await fetch(`${FHIR_BASE_URL}/Organization/${orgId}`);
            if (orgRes.ok) {
                const org = await orgRes.json();
                const name = org.name ?? "(æœªå‘½å)";
                const addr = org.address?.[0]?.text ?? "(ç„¡åœ°å€)";
                communityStoreText = `${name} â€” ${addr}`;

                // â­ ç·¨è¼¯æ¨¡å¼é¸å–® â†’ è‡ªå‹•é¸ä¸­è©²å°å•†åº—
                const select = document.getElementById("communityAddress");
                select.value = orgId;
            }
        }

        // é¡¯ç¤ºåœ¨ view mode
        document.getElementById("view-communityAddress").innerText = communityStoreText;

        // === ç·¨è¼¯æ¨¡å¼åˆå§‹å€¼ ===
        document.getElementById("birthDate").value = patient.birthDate ?? "";
        if (patient.gender) {
            document.querySelector(`input[name="gender"][value="${patient.gender}"]`).checked = true;
        }
        document.getElementById("phone").value = 
            patient.telecom?.find(t => t.system === "phone")?.value ?? "";

        document.getElementById("address").value =
            patient.address?.find(a => a.use === "home")?.text ?? "";

        // â­ communityAddress çš„å€¼ç¾åœ¨ç”¨ orgIdï¼Œä¸å†æ”¾åœ°å€
        // ï¼ˆä¸Šé¢å·²ç¶“åœ¨ select.value è¨­å¥½äº†ï¼‰

    } catch (err) {
        console.error("âŒ è¼‰å…¥ Patient è³‡æ–™å¤±æ•—ï¼š", err);
    }
}

// 3ï¸âƒ£ å»ºç«‹æˆ–æ›´æ–° Patient
async function savePatientData() {
    try {
        const name = document.getElementById("name").value;
        const birthDate = document.getElementById("birthDate").value;
        const gender = document.querySelector('input[name="gender"]:checked')?.value;
        const phone = document.getElementById("phone").value;
        const homeAddress = document.getElementById("address").value;

        // â­ é€™è£¡å¯«çš„æ˜¯ Organization çš„ ID
        const communityOrgId = document.getElementById("communityAddress").value.trim();

        if (!name || !birthDate || !gender || !phone || !homeAddress||!communityOrgId) {
            alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™");
            return;
        }

        const patientPayload = {
            resourceType: "Patient",
            name: [{ text: name }],
            birthDate,
            gender,
            telecom: [
                { system: "phone", value: phone }
            ],
            address: [
                { use: "home", text: homeAddress }
            ],
            contact: []
        };

        // â­ emailï¼ˆè‹¥ Person æœ‰å­˜ï¼‰
        if (currentPersonEmail) {
            patientPayload.telecom.push({
                system: "email",
                value: currentPersonEmail
            });
        }

        // â­ å°‡çµ„ç¹” ID æ”¾é€² contact.organization
        if (communityOrgId) {
            patientPayload.contact.push({
                organization: {
                    reference: `Organization/${communityOrgId}`
                }
            });
        }

        // â­ æ±ºå®šæ˜¯æ–°å¢é‚„æ˜¯æ›´æ–°
        let method = "POST", url = `${FHIR_BASE_URL}/Patient`;
        if (currentPatientId) {
            method = "PUT";
            url = `${FHIR_BASE_URL}/Patient/${currentPatientId}`;
            patientPayload.id = currentPatientId;
        }

        const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/fhir+json" },
            body: JSON.stringify(patientPayload)
        });

        const patient = await res.json();

        if (!res.ok || !patient.id) {
            console.error("âŒ å„²å­˜ Patient å¤±æ•—", patient);
            throw new Error("FHIR Server å„²å­˜å¤±æ•—");
        }

        currentPatientId = patient.id;

        await linkPersonToPatient(currentPersonId, currentPatientId);
        await loadPatientData(currentPatientId);

        switchToViewMode();
        alert("âœ… å€‹äººè³‡æ–™å·²å„²å­˜");

    } catch (err) {
        console.error("âŒ å„²å­˜ Patient è³‡æ–™å¤±æ•—ï¼š", err);
        alert("å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
}


async function loadCommunityStores() {
    try {
        // â­ ç”¨ type=community-store (type ç³»çµ±å€¼æœƒä¾ä½ å¯¦éš›çš„ code èª¿æ•´)
        const url = `${FHIR_BASE_URL}/Organization?type=Community%20Store`;
        const res = await fetch(url);

        if (!res.ok) throw new Error("ç„¡æ³•å–å¾—ç¤¾å€å°å•†åº—");

        const data = await res.json();
        const stores = data.entry?.map(e => e.resource) ?? [];

        const select = document.getElementById("communityAddress");
        select.innerHTML = '<option value="">è«‹é¸æ“‡ç¤¾å€å°å•†åº—</option>';

        stores.forEach(store => {
            const name = store.name ?? "æœªå‘½åå•†åº—";
            const addr = store.address?.[0]?.text ?? "(ç„¡åœ°å€)";
            const option = document.createElement("option");

            // â­ é€™è£¡æ”¹ç‚º IDï¼ˆæ­£ç¢ºå­˜æ³•ï¼‰
            option.value = store.id;

            // â­ é¡¯ç¤ºåç¨± + åœ°å€ï¼ˆåªæ˜¯é¡¯ç¤ºï¼Œä¸å­˜ï¼‰
            option.textContent = `${name} â€” ${addr}`;

            select.appendChild(option);
        });

    } catch (err) {
        console.error("âŒ ç„¡æ³•è¼‰å…¥ç¤¾å€å°å•†åº—ï¼š", err);
    }
}


// 5ï¸âƒ£ å°‡ Person.link æŒ‡å‘ Patient
async function linkPersonToPatient(personId, patientId) {
    try {
        // 1ï¸âƒ£ å–å¾—ç¾æœ‰ Person
        const resGet = await fetch(`${FHIR_BASE_URL}/Person/${personId}`);
        if (!resGet.ok) throw new Error("ç„¡æ³•å–å¾— Person");
        const person = await resGet.json();

        // 2ï¸âƒ£ æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰é€™å€‹ Patient
        const exists = person.link?.some(l => l.target.reference === `Patient/${patientId}`);
        if (!exists) {
            person.link = person.link || [];
            person.link.push({ target: { reference: `Patient/${patientId}` }, assurance: "level1" });
        }

        // 3ï¸âƒ£ PUT æ•´å€‹ Person
        const resPut = await fetch(`${FHIR_BASE_URL}/Person/${personId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/fhir+json" },
            body: JSON.stringify(person)
        });

        if (!resPut.ok) throw new Error("ç„¡æ³•æ›´æ–° Person.link");
        console.log("âœ… Person.link å·²æ›´æ–°");
    } catch (err) {
        console.error("âŒ Person.link æ›´æ–°å¤±æ•—ï¼š", err);
    }
}
function hideOrganizationModal() {
    const modal = document.getElementById("organizationModal");
    if (modal) {
        modal.style.display = "none"; // éš±è— modal
    }
}

async function loadHospitals() {
    try {
        const res = await fetch("http://203.64.84.209:8080/fhir/Organization?type=http://hl7.org/fhir/organization-type|hospital");
        if (!res.ok) throw new Error("ç„¡æ³•å–å¾—é†«é™¢è³‡æ–™");

        const data = await res.json();

        // FHIR search å›å‚³æ˜¯ Bundle
        const hospitals = data.entry?.map(e => e.resource) ?? [];

        console.log("å–å¾—çš„é†«é™¢åˆ—è¡¨ï¼š", hospitals);

        // ä¾‹å¦‚å¯ä»¥æŠŠ id èˆ‡ name æ”¾å…¥ä¸‹æ‹‰é¸å–®
        const select = document.getElementById("organizationSelect");
        select.innerHTML = '<option value="">è«‹é¸æ“‡é†«ç™‚æ©Ÿæ§‹</option>';
        hospitals.forEach(org => {
            const option = document.createElement("option");
            option.value = org.id;
            option.textContent = org.name ?? "æœªå‘½åé†«é™¢";
            select.appendChild(option);
        });

    } catch (err) {
        console.error("âŒ è¼‰å…¥é†«é™¢å¤±æ•—ï¼š", err);
    }
}
async function refreshCommunications() {
    const container = document.getElementById("communications-container");
    const listEl = document.getElementById("communications-list");
    const noCommEl = document.getElementById("no-communications");

    try {
        // å–å¾—æ‰€æœ‰ Communication
        const res = await fetch(`${FHIR_BASE_URL}/Communication`);
        if (!res.ok) throw new Error("ç„¡æ³•å–å¾—é€šçŸ¥è³‡æ–™");

        const data = await res.json();
        let communications = data.entry?.map(e => e.resource) ?? [];

        // ç”¨ payload å…§ email éæ¿¾
        communications = communications.filter(comm => {
            const payloadText = comm.payload?.map(p => p.contentString).join(" ") ?? "";
            return payloadText.includes(currentPersonEmail); // currentPersonEmail = ç—…äººçš„ email
        });

        // æ¸…ç©ºèˆŠåˆ—è¡¨
        listEl.innerHTML = "";

        if (communications.length === 0) {
            noCommEl.style.display = "block";
            noCommEl.innerText = "ç›®å‰æ²’æœ‰é€šçŸ¥";
            listEl.style.display = "none";
            return;
        }

        noCommEl.style.display = "none";
        listEl.style.display = "block";

        communications.forEach(comm => {
            const commDiv = document.createElement("div");
            commDiv.classList.add("info-group");

            const status = comm.status ?? "unknown";
            const sent = comm.sent ? new Date(comm.sent).toLocaleString() : "æœªæä¾›æ™‚é–“";
            const contentText = comm.payload?.map(p => p.contentString ?? "").join("\n") ?? "ç„¡å…§å®¹";

            commDiv.innerHTML = `
                <div class="info-label">ğŸ“Œ ç‹€æ…‹: ${status}</div>
                <div class="info-label">â° ç™¼é€æ™‚é–“: ${sent}</div>
                <div class="info-value">${contentText}</div>
            `;

            // â­ æ–°å¢ã€Œå·²è®€ã€æŒ‰éˆ•
            const readBtn = document.createElement("button");
            readBtn.textContent = "âœ… å·²è®€";
            readBtn.classList.add("mark-read-btn");
            readBtn.addEventListener("click", async () => {
                try {
                    const delRes = await fetch(`${FHIR_BASE_URL}/Communication/${comm.id}`, {
                        method: "DELETE"
                    });
                    if (!delRes.ok) throw new Error("åˆªé™¤å¤±æ•—");

                    // å¾ç•«é¢ç§»é™¤
                    commDiv.remove();

                    // å¦‚æœåˆ—è¡¨å·²ç©ºï¼Œé¡¯ç¤ºæç¤º
                    if (listEl.children.length === 0) {
                        noCommEl.style.display = "block";
                        noCommEl.innerText = "ç›®å‰æ²’æœ‰é€šçŸ¥";
                        listEl.style.display = "none";
                    }
                } catch (err) {
                    console.error("âŒ åˆªé™¤é€šçŸ¥å¤±æ•—ï¼š", err);
                    alert("åˆªé™¤é€šçŸ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                }
            });

            commDiv.appendChild(readBtn);
            listEl.appendChild(commDiv);
        });

    } catch (err) {
        console.error("âŒ å–å¾—é€šçŸ¥å¤±æ•—ï¼š", err);
        noCommEl.style.display = "block";
        noCommEl.innerText = "å–å¾—é€šçŸ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
        listEl.style.display = "none";
    }
}


async function syncPatientToOrganization() {
    const patientId = currentPatientId; // ä½ ç¾æœ‰çš„ Patient ID
    const orgId = document.getElementById("organizationSelect").value;

    if (!patientId) {
        alert("âŒ å°šæœªå»ºç«‹ Patient");
        return;
    }
    if (!orgId) {
        alert("âŒ è«‹å…ˆé¸æ“‡é†«é™¢");
        return;
    }

    try {
        // 1ï¸âƒ£ å…ˆå¾æœ¬åœ° FHIR Server å–å¾— Patient è³‡æ–™
        const resPatient = await fetch(`${FHIR_BASE_URL}/Patient/${patientId}`);
        if (!resPatient.ok) throw new Error("ç„¡æ³•å–å¾— Patient è³‡æ–™");
        const patient = await resPatient.json();

        // 2ï¸âƒ£ è¨­å®š managingOrganization
        patient.managingOrganization = {
            reference: `Organization/${orgId}`
        };

        // 3ï¸âƒ£ ç§»é™¤ä¸å¿…è¦çš„æ¬„ä½ï¼ˆid, meta, text ç­‰ï¼Œå¦‚æœæƒ³åœ¨æ–° server è‡ªå‹•ç”¢ç”Ÿ idï¼‰
        delete patient.id;
        delete patient.meta;

        // 4ï¸âƒ£ POST åˆ°å¦ä¸€å€‹ FHIR Server
        const targetServer = "http://203.64.84.209:8080/fhir";
        const res = await fetch(`${targetServer}/Patient`, {
            method: "POST",
            headers: { "Content-Type": "application/fhir+json" },
            body: JSON.stringify(patient)
        });

        if (!res.ok) throw new Error("åŒæ­¥ Patient åˆ°é†«é™¢å¤±æ•—");

        const newPatient = await res.json();
        console.log("âœ… Patient æˆåŠŸåŒæ­¥åˆ°é†«é™¢:", newPatient);

        document.getElementById("syncStatus").style.display = "block";
        document.getElementById("syncStatus").innerText = `âœ… Patient å·²åŒæ­¥è‡³ ${orgId}ï¼Œæ–° ID: ${newPatient.id}`;

        // é¸æ“‡å®Œå¯ä»¥é—œé–‰ modal
        hideOrganizationModal();

    } catch (err) {
        console.error("âŒ åŒæ­¥ Patient å¤±æ•—ï¼š", err);
        document.getElementById("syncStatus").style.display = "block";
        document.getElementById("syncStatus").innerText = `âŒ åŒæ­¥å¤±æ•—ï¼š${err.message}`;
    }
}



function showOrganizationLink() {
    document.getElementById("organizationModal").style.display = "block";
    loadHospitals(); // ç«‹å³è¼‰å…¥é†«é™¢é¸å–®
}
// åˆ‡æ›æª¢è¦–/ç·¨è¼¯æ¨¡å¼
function switchToViewMode() {
    document.getElementById("editMode").style.display = "none";
    document.getElementById("viewMode").style.display = "block";
}
function applyMedicineDelivery() {
    window.location.href = "medicine-delivery.html";
}

function switchToEditMode() {
    document.getElementById("editMode").style.display = "block";
    document.getElementById("viewMode").style.display = "none";
}

</script>

</body>
</html>