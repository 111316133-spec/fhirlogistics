<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Portal ç®¡ç†å“¡ - å¯©æ ¸ç”³è«‹</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 2rem; 
      background: #f0f2f5; 
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { 
      color: #333;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-bottom: 1rem; 
    }
    th, td { 
      padding: 0.75rem; 
      border: 1px solid #ddd; 
      text-align: left; 
    }
    th { 
      background: #667eea; 
      color: #fff; 
      font-weight: bold;
    }
    tr:nth-child(even) {
      background: #f8f9fa;
    }
    tr:hover {
      background: #e9ecef;
    }
    button { 
      padding: 0.5rem 1rem; 
      margin-right: 0.5rem; 
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }
    .approve-btn {
      background: #28a745;
      color: white;
    }
    .approve-btn:hover {
      background: #218838;
    }
    .reject-btn {
      background: #dc3545;
      color: white;
    }
    .reject-btn:hover {
      background: #c82333;
    }
    #message { 
      margin-bottom: 1rem; 
      padding: 0.75rem;
      border-radius: 4px;
      display: none;
    }
    .message-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .message-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #666;
      font-style: italic;
    }
    .delete-btn {
  background: #6c757d;
  color: white;
}
.delete-btn:hover {
  background: #5a6268;
}
  </style>
</head>
<body>

<div class="container">
  <h1>Portal ç®¡ç†å“¡ - å¯©æ ¸æ©Ÿæ§‹çµ„ç¹”ç”³è«‹</h1>
  <button id="logoutBtn" style="float:right; background:#2453ec;">ç™»å‡º</button>
  <div id="message"></div>

  <table id="requestTable">
    <thead>
  <tr>
    <th>å…¬å¸åç¨±</th>
    <th>çµ„ç¹”é¡å‹</th>
    <th>ç”³è«‹è€… Email</th>
    <th>è·ä½</th>
    <th>ç”³è«‹æ™‚é–“</th>
    <th>åœ°å€</th>
    <th>æ“ä½œ</th>
  </tr>
</thead>

    <tbody>
      <tr>
        <td colspan="6" class="loading">è¼‰å…¥ä¸­...</td>
      </tr>
    </tbody>
  </table>
</div>

<script>
// =========================
// å…¨åŸŸè®Šæ•¸
// =========================
let requests = [];

// =========================
// é¡¯ç¤ºè¨Šæ¯
// =========================
function showMessage(msg, success = false) {
  const div = document.getElementById("message");
  div.textContent = msg;
  div.className = success ? "message-success" : "message-error";
  div.style.display = "block";
  
  // è‡ªå‹•éš±è—æˆåŠŸè¨Šæ¯
  if (success) {
    setTimeout(() => {
      div.style.display = "none";
    }, 5000);
  }
}

// =========================
// è¼‰å…¥å¾…å¯©æ ¸è³‡æ–™
// =========================
async function loadRequests() {
  const tbody = document.querySelector("#requestTable tbody");
  
  try {
    console.log("ğŸ” é–‹å§‹è¼‰å…¥å¾…å¯©æ ¸ç”³è«‹...");
    const res = await fetch("/api/admin/pending-logistics", { 
      credentials: "include" 
    });
    
    if (!res.ok) {
      throw new Error(`ç„¡æ³•è¼‰å…¥ç”³è«‹è³‡æ–™: ${res.status}`);
    }
    
    requests = await res.json();
    console.log("âœ… è¼‰å…¥åˆ°çš„ç”³è«‹è³‡æ–™:", requests);
    
    renderTable();
    
  } catch(err) {
    console.error("âŒ è¼‰å…¥å¤±æ•—:", err);
    tbody.innerHTML = `<tr><td colspan="6" style="color: red; text-align: center;">è¼‰å…¥å¤±æ•—: ${err.message}</td></tr>`;
    showMessage(`è¼‰å…¥å¤±æ•—: ${err.message}`);
  }
}
// ç™»å‡ºæŒ‰éˆ•
document.getElementById("logoutBtn").addEventListener("click", async () => {


  try {
    const res = await fetch("/api/logout", {
      method: "POST",
      credentials: "include"
    });

    if (!res.ok) {
      const err = await res.text();
      throw new Error(err || "ç™»å‡ºå¤±æ•—");
    }

    // ç™»å‡ºæˆåŠŸå¾Œè·³è½‰åˆ°ç™»å…¥é 
    window.location.href = "/login.html";

  } catch (err) {
    console.error("âŒ ç™»å‡ºå¤±æ•—:", err);
    showMessage(`ç™»å‡ºå¤±æ•—ï¼š${err.message}`);
  }
});

// =========================
// æ¸²æŸ“è¡¨æ ¼ï¼ˆå«é€šé/æ‹’çµ•æŒ‰éˆ•ï¼‰
// =========================
function renderTable() {
  const tbody = document.querySelector("#requestTable tbody");

  if (requests.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="empty-state">
          ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„ç”³è«‹
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = "";

  requests.forEach(request => {
    const tr = document.createElement("tr");

    const address = request.address || "æœªå¡«å¯«åœ°å€";

    tr.innerHTML = `
      <td><strong>${request.orgName || 'æœªå‘½åå…¬å¸'}</strong></td>
      <td>${request.orgType || 'logistics'}</td>
      <td>${request.email || 'æœªæä¾› Email'}</td>
      <td>${request.position || request.roleDisplay || 'æœªè¨­å®šè·ä½'}</td>


      <td>${new Date(request.createdAt || Date.now()).toLocaleDateString('zh-TW')}</td>
      <td>${address}</td>
      <td>
        <button class="approve-btn" onclick="approveRequest('${request.organizationId}')">


          é€šé
        </button>
        <button class="reject-btn" onclick="rejectRequest('${request.organizationId}')">
          æ‹’çµ•
        </button>
        <button class="delete-btn" onclick="deleteOrg('${request.organizationId}')">åˆªé™¤
          </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// =========================
// é€šéç”³è«‹
// =========================
async function approveRequest(organizationId) {
  const request = requests.find(r => r.organizationId === organizationId);

  if (!request) {
    showMessage("æ‰¾ä¸åˆ°è©²ç”³è«‹è³‡æ–™");
    return;
  }

  if (!confirm(`ç¢ºå®šè¦é€šéã€Œ${request.orgName}ã€çš„ç”³è«‹å—ï¼Ÿ`)) {
    return;
  }

  try {
    console.log("âœ… é–‹å§‹é€šéç”³è«‹:", organizationId);
    
    // é¦–å…ˆéœ€è¦å–å¾— Practitioner å’Œ PractitionerRole çš„ ID
    const roleRes = await fetch(
      `${FHIR_BASE}/PractitionerRole?organization=Organization/${organizationId}`,
      { credentials: "include" }
    );
    
    if (!roleRes.ok) {
      throw new Error("ç„¡æ³•å–å¾—è§’è‰²è³‡æ–™");
    }
    
    const roleData = await roleRes.json();
    console.log("ğŸ” è§’è‰²è³‡æ–™:", roleData);
    
    if (!roleData.entry || roleData.entry.length === 0) {
      throw new Error("æ‰¾ä¸åˆ°å°æ‡‰çš„è§’è‰²è³‡æ–™");
    }
    
    const role = roleData.entry[0].resource;
    const practitionerId = role.practitioner.reference.split('/')[1];
    const roleId = role.id;
    
    console.log("ğŸ” æ‰¾åˆ°çš„ ID:", { organizationId, practitionerId, roleId });

    const res = await fetch(`/api/admin/approve-logistics`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ 
        organizationId: organizationId,
        practitionerId: practitionerId,
        roleId: roleId
      })
    });

    const result = await res.json();

    if (!res.ok) {
      throw new Error(result.error || result.detail || "é€šéç”³è«‹å¤±æ•—");
    }

    showMessage(`âœ… å·²é€šéç”³è«‹ï¼š${request.orgName}`, true);
    console.log("âœ… é€šéç”³è«‹æˆåŠŸ:", result);

    // å¾å‰ç«¯åˆ—è¡¨ç§»é™¤
    requests = requests.filter(r => r.organizationId !== organizationId);

    renderTable();

  } catch (err) {
    console.error("âŒ é€šéç”³è«‹å¤±æ•—:", err);
    showMessage(`âŒ é€šéç”³è«‹å¤±æ•—: ${err.message}`);
  }
}

// =========================
// æ‹’çµ•ç”³è«‹
// =========================
async function rejectRequest(organizationId) {
  const request = requests.find(r => r.organizationId === organizationId);

  if (!request) {
    showMessage("æ‰¾ä¸åˆ°è©²ç”³è«‹è³‡æ–™");
    return;
  }

  const reason = prompt(`è«‹è¼¸å…¥æ‹’çµ•ã€Œ${request.orgName}ã€ç”³è«‹çš„åŸå› ï¼š`);
  if (!reason) {
    showMessage("å·²å–æ¶ˆæ‹’çµ•æ“ä½œ");
    return;
  }

  if (reason.trim().length === 0) {
    showMessage("è«‹è¼¸å…¥æ‹’çµ•åŸå› ");
    return;
  }

  try {
    console.log("âŒ é–‹å§‹æ‹’çµ•ç”³è«‹:", organizationId);
    
    // é¦–å…ˆéœ€è¦å–å¾— Practitioner å’Œ PractitionerRole çš„ ID
    const roleRes = await fetch(
      `${FHIR_BASE}/PractitionerRole?organization=Organization/${organizationId}`,
      { credentials: "include" }
    );
    
    if (!roleRes.ok) {
      throw new Error("ç„¡æ³•å–å¾—è§’è‰²è³‡æ–™");
    }
    
    const roleData = await roleRes.json();
    console.log("ğŸ” è§’è‰²è³‡æ–™:", roleData);
    
    if (!roleData.entry || roleData.entry.length === 0) {
      throw new Error("æ‰¾ä¸åˆ°å°æ‡‰çš„è§’è‰²è³‡æ–™");
    }
    
    const role = roleData.entry[0].resource;
    const practitionerId = role.practitioner.reference.split('/')[1];
    const roleId = role.id;

    const res = await fetch(`/api/admin/reject-admin`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({
        organizationId: organizationId,
        practitionerId: practitionerId,
        roleId: roleId,
        reason: reason.trim()
      })
    });

    const result = await res.json();

    if (!res.ok) {
      throw new Error(result.error || result.detail || "æ‹’çµ•ç”³è«‹å¤±æ•—");
    }

    showMessage(`âŒ å·²æ‹’çµ•ç”³è«‹ï¼š${request.orgName}`, true);
    console.log("âœ… æ‹’çµ•ç”³è«‹æˆåŠŸ:", result);

    // å¾å‰ç«¯åˆ—è¡¨ç§»é™¤
    requests = requests.filter(r => r.organizationId !== organizationId);

    renderTable();

  } catch (err) {
    console.error("âŒ æ‹’çµ•ç”³è«‹å¤±æ•—:", err);
    showMessage(`âŒ æ‹’çµ•ç”³è«‹å¤±æ•—: ${err.message}`);
  }
}
// =========================
// åˆªé™¤ç”³è«‹
// =========================

async function deleteOrg(organizationId) {
  const request = requests.find(r => r.organizationId === organizationId);
  if (!request) {
    showMessage("æ‰¾ä¸åˆ°è©²ç”³è«‹è³‡æ–™");
    return;
  }

  if (!confirm(`âš  ç¢ºå®šè¦åˆªé™¤ã€Œ${request.orgName}ã€åŠå…¶è§’è‰²è³‡æ–™å—ï¼Ÿ\næ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼`)) {
    return;
  }

  try {
    // 1. æ‰¾ PractitionerRole
    const roleRes = await fetch(
      `${FHIR_BASE}/PractitionerRole?organization=Organization/${organizationId}`,
      { credentials: "include" }
    );

    if (!roleRes.ok) throw new Error("æŸ¥è©¢å°æ‡‰è§’è‰²å¤±æ•—");

    const roleData = await roleRes.json();

    if (!roleData.entry || roleData.entry.length === 0)
      throw new Error("æ‰¾ä¸åˆ° PractitionerRole");

    const role = roleData.entry[0].resource;
    const roleId = role.id;

    // 2. åŸ·è¡Œåˆªé™¤ PractitionerRole
    const delRole = await fetch(`${FHIR_BASE}/PractitionerRole/${roleId}`, {
      method: "DELETE",
      credentials: "include"
    });

    if (!delRole.ok) {
      const err = await delRole.text();
      throw new Error(`åˆªé™¤ PractitionerRole å¤±æ•—: ${err}`);
    }

    // 3. åˆªé™¤ Organization
    const delOrg = await fetch(`${FHIR_BASE}/Organization/${organizationId}`, {
      method: "DELETE",
      credentials: "include"
    });

    if (!delOrg.ok) {
      const err = await delOrg.text();
      throw new Error(`åˆªé™¤ Organization å¤±æ•—: ${err}`);
    }

    showMessage(`ğŸ—‘ å·²åˆªé™¤çµ„ç¹”ã€Œ${request.orgName}ã€èˆ‡å…¶è§’è‰²è³‡æ–™`, true);

    // 4. å¾å‰ç«¯ UI ç§»é™¤
    requests = requests.filter(r => r.organizationId !== organizationId);
    renderTable();

  } catch (err) {
    console.error("âŒ åˆªé™¤å¤±æ•—:", err);
    showMessage(`åˆªé™¤å¤±æ•—ï¼š${err.message}`);
  }
}

// =========================
// æ·»åŠ å…¨åŸŸè®Šæ•¸ï¼ˆéœ€è¦èˆ‡å¾Œç«¯ä¸€è‡´ï¼‰
// =========================
const FHIR_BASE = 'http://203.64.84.204:8080/fhir'; // èˆ‡å¾Œç«¯ä¿æŒä¸€è‡´

// =========================
// åˆå§‹è¼‰å…¥
// =========================
document.addEventListener("DOMContentLoaded", () => {
  console.log("ğŸš€ ç®¡ç†å“¡é é¢è¼‰å…¥å®Œæˆ");
  loadRequests();
  
  // å®šæœŸåˆ·æ–°è³‡æ–™ï¼ˆæ¯30ç§’ï¼‰
  setInterval(loadRequests, 30000);
});
</script>

</body>
</html>