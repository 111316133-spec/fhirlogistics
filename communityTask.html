<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¤¾å€å¿—å·¥ â€” ç‰©è³‡é…é€ä»»å‹™</title>

<style>
:root {
   --primary: #4b6bff;
   --primary-light: #6d86ff;
   --success: #4caf50;
   --warning: #ff9800;
   --info: #2196f3;
   --secondary: #8c5cff;
   --danger: #f44336;
   --light: #f3f5ff;
   --dark: #333;
   --radius: 10px;
   --shadow: 0 4px 14px rgba(0,0,0,0.08);
}

body {
   margin:0;
   background:var(--light);
   font-family:"Segoe UI","Microsoft JhengHei",sans-serif;
   color: var(--dark);
}

/* ---- Header ---- */
.header {
   background: linear-gradient(135deg, var(--primary), var(--primary-light));
   padding:20px;
   color:white;
   font-size:22px;
   font-weight:600;
   display:flex;
   justify-content:space-between;
   align-items:center;
   box-shadow: var(--shadow);
}

.user-info {
   font-size: 14px;
   opacity: 0.95;
}

/* ---- Layout ---- */
.container {
   padding:30px;
   max-width:1200px;
   margin:0 auto;
}

h2 {
   margin:5px 0 15px 0;
   font-weight:600;
   color: var(--dark);
}

/* ---- Table ---- */
table {
   width:100%;
   border-collapse:collapse;
   background:white;
   border-radius: var(--radius);
   overflow:hidden;
   box-shadow: var(--shadow);
}

thead {
   background: var(--primary);
   color:white;
}

thead th {
   padding:14px;
   font-size:15px;
   letter-spacing:0.5px;
}

tbody tr {
   border-bottom:1px solid #eee;
}

tbody tr:hover {
   background:#f8faff;
}

td {
   padding:12px 15px;
   font-size:14px;
   color:#444;
}

/* ---- Status badge ---- */
.status-badge {
   display:inline-block;
   padding:6px 12px;
   border-radius:20px;
   font-size:12px;
   font-weight:600;
}

.status-active { background:#e8f5e8; color:var(--success); }
.status-in-progress { background:#fff3e0; color:var(--warning); }
.status-processing { background:#e3f2fd; color:var(--info); }
.status-completed { background:#e8f5e8; color:var(--success); }
.status-cancelled { background:#ffebee; color:var(--danger); }

/* ---- Buttons ---- */
.btn {
   padding:8px 18px;
   border-radius: var(--radius);
   border:none;
   cursor:pointer;
   color:white;
   font-size:14px;
   font-weight:600;
   transition:0.2s;
   box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.btn:hover {
   transform: translateY(-1px);
   box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.start { background: var(--warning); }
.done { background: var(--info); }

.btn:disabled {
   background:#bbb !important;
   cursor:not-allowed;
   opacity:0.7;
   box-shadow:none;
}

/* ---- Loading / Error ---- */
.loading {
   text-align:center;
   padding:20px;
   color:#666;
}

.error {
   background:#ffe5e7;
   color:#c62828;
   padding:15px;
   border-radius: var(--radius);
   margin-top:10px;
}

/* ---- Empty State ---- */
.empty-state {
   padding:40px 20px;
   text-align:center;
   color:#555;
}

/* ---- Card Style (è‹¥ä½ è¦ç”¨) ---- */
.card {
   background:white;
   padding:20px;
   border-radius:var(--radius);
   box-shadow: var(--shadow);
   margin-bottom:20px;
}

</style>

</head>
<body>

<div class="header">
   <div>ç¤¾å€å¿—å·¥ â€” è—¥å“é…é€ä»»å‹™</div>
    <div class="user-info" id="userInfo">è¼‰å…¥ä¸­...</div>
        <button id="logoutBtn" 
              style="background:#476ff3;color: white ;padding:6px 14px; border-radius:8px; cursor:pointer;">
        ç™»å‡º
      </button>
</div>

<div class="container">
  <h2>æˆ‘çš„ä»»å‹™</h2>
  <table border="1" width="100%" id="taskTable">
    <thead>
      <tr>
        <th>Task ID</th>
        <th>ç‰©å“</th>
        <th>æ•¸é‡</th>
        <th>ç—…äººåœ°å€</th>
        <th>ç‹€æ…‹</th>
        <th>å‚™è¨»</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="taskTableBody">
      <tr><td colspan="6" class="loading">è¼‰å…¥ä¸­...</td></tr>
    </tbody>
  </table>
</div>
  

<script>
const FHIR_BASE = "http://203.64.84.204:8080/fhir";
async function loadUserInfo() {
  const userInfoDiv = document.getElementById("userInfo");
  try {
    const res = await fetch('/api/organizations');
    const orgs = await res.json();

    if (!orgs.length) {
      userInfoDiv.textContent = "æœªç™»å…¥æˆ–ç„¡çµ„ç¹”è³‡æ–™";
      return;
    }

    const firstOrg = orgs[0];
    const practitionerId = firstOrg.practitionerId;
    const orgName = firstOrg.orgName;
    const roleDisplay = firstOrg.roleDisplay;

    userInfoDiv.textContent = `Practitioner ID: ${practitionerId} | çµ„ç¹”: ${orgName} | è·ä½: ${roleDisplay}`;
  } catch (err) {
    userInfoDiv.textContent = "å–å¾—ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—";
    console.error(err);
  }
}

/* ------------------------------
   æŠ“ç—…äººåœ°å€
------------------------------ */
async function getPatientAddress(patientRef) {
  if (!patientRef) return "-";

  try {
    const res = await fetch(`${FHIR_BASE}/${patientRef}`);
    const patient = await res.json();

    const addr = patient.address?.[0];
    if (!addr) return "-";

    return (
      addr.text ||
      `${addr.country || ""}${addr.state || ""}${addr.city || ""}${addr.district || ""}${addr.line?.join("") || ""}`
    );
  } catch {
    return "-";
  }
}

/* ------------------------------
   è®€å–ä»»å‹™
------------------------------ */
async function loadMyTasks() {
  const tbody = document.getElementById("taskTableBody");
  tbody.innerHTML = `<tr><td colspan="6" class="loading">è¼‰å…¥ä¸­...</td></tr>`;

  try {
    const orgsRes = await fetch('/api/organizations');
    const orgs = await orgsRes.json();

    if (!orgs.length) {
      tbody.innerHTML = `<tr><td colspan="6">ç„¡ä»»å‹™ (ç„¡çµ„ç¹”æˆ–æœªç™»å…¥)</td></tr>`;
      return;
    }

    const currentPractitionerId = orgs[0].practitionerId;

    const res = await fetch(`${FHIR_BASE}/Task?owner=Practitioner/${currentPractitionerId}&_count=100`);
    const bundle = await res.json();

    if (!bundle.entry?.length) {
      tbody.innerHTML = `<tr><td colspan="6">ç›®å‰æ²’æœ‰ä»»å‹™</td></tr>`;
      return;
    }

    tbody.innerHTML = "";

    for (const e of bundle.entry) {
      const task = e.resource;

      let item = "-", quantity = "-";
      task.input?.forEach(input => {
        if (input.type?.coding?.[0]?.code === "medication")
          item = input.valueCodeableConcept?.text || "-";
        if (input.type?.coding?.[0]?.code === "medication-quantity")
          quantity = `${input.valueQuantity?.value || "-"} ${input.valueQuantity?.unit || ""}`;
      });

      // å–å¾—ç—…äººåœ°å€
      let patientAddress = "-";
      if (task.focus?.reference) {
        try {
          const srRes = await fetch(`${FHIR_BASE}/${task.focus.reference}`);
          const supplyReq = await srRes.json();

          const patientRef = supplyReq.requester?.reference;
          patientAddress = await getPatientAddress(patientRef);
        } catch {
          patientAddress = "-";
        }
      }

      const tr = document.createElement("tr");
      tr.setAttribute("data-id", task.id);

      tr.innerHTML = `
        <td>${task.id}</td>
        <td>${item}</td>
        <td>${quantity}</td>
        <td>${patientAddress}</td>
        <td id="status-${task.id}">${task.status}</td>
        <td>${task.note?.[0]?.text || "-"}</td>
        <td>
          <button onclick="updateTaskStatus('${task.id}', 'in-progress')" class="btn start"
            ${task.status === 'completed' ? 'disabled' : ''}>é…é€ä¸­</button>
          
          <button onclick="updateTaskStatus('${task.id}', 'completed')" class="btn done"
            ${task.status === 'completed' ? 'disabled' : ''}>å®Œæˆ</button>
        </td>
      `;

      tbody.appendChild(tr);
    }

  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="6" class="error">è¼‰å…¥ä»»å‹™å¤±æ•—: ${err.message}</td></tr>`;
    console.error(err);
  }
}

/* ------------------------------
   å‹•ç•«æ·¡å‡ºå¾Œåˆªé™¤ä»»å‹™åˆ—
------------------------------ */
function fadeOutAndRemoveRow(taskId) {
  const row = document.querySelector(`tr[data-id="${taskId}"]`);
  if (!row) return;

  row.style.transition = "opacity 0.5s";
  row.style.opacity = "0";

  setTimeout(() => row.remove(), 500);
}

/* ------------------------------
   æ›´æ–°ä»»å‹™ç‹€æ…‹
------------------------------ */
async function updateTaskStatus(taskId, newStatus) {
  try {
    const ops = [{ op: "replace", path: "/status", value: newStatus }];
    const res = await fetch(`${FHIR_BASE}/Task/${taskId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json-patch+json" },
      body: JSON.stringify(ops)
    });

    if (!res.ok) throw new Error("ä»»å‹™ç‹€æ…‹æ›´æ–°å¤±æ•—");

    // è‹¥å®Œæˆ â†’ å»ºç«‹ Communication
    if (newStatus === "completed") {
      await sendCompletionCommunication(taskId);

      // ç›´æ¥å¾ UI æŠŠé€™åˆ—ç§»é™¤ï¼Œä¸åˆ·æ–°æ•´è¡¨
      fadeOutAndRemoveRow(taskId);

      alert("âœ” é…é€å®Œæˆï¼è©²ä»»å‹™å·²å¾æ¸…å–®ç§»é™¤");
    } else {
      // æ›´æ–°ç‹€æ…‹æ¬„ä½
      const td = document.getElementById(`status-${taskId}`);
      if (td) td.textContent = newStatus;

      alert("âœ” ä»»å‹™ç‹€æ…‹å·²æ›´æ–°");
    }

  } catch (err) {
    alert("âŒ ä»»å‹™æ›´æ–°å¤±æ•—: " + err.message);
  }
}

/* ------------------------------
   å»ºç«‹é…é€å®Œæˆçš„ Communication
------------------------------ */
async function sendCompletionCommunication(taskId) {
  const taskRes = await fetch(`${FHIR_BASE}/Task/${taskId}`);
  const task = await taskRes.json();

  const supplyRef = task.focus?.reference;
  if (!supplyRef) return alert("æ‰¾ä¸åˆ° Task çš„ SupplyRequest");

  const supplyId = supplyRef.split("/")[1];

  const srRes = await fetch(`${FHIR_BASE}/SupplyRequest/${supplyId}`);
  const supply = await srRes.json();

  const patientId = supply.requester?.reference?.split("/")[1];
  if (!patientId) return alert("SupplyRequest ç¼º requester(ç—…äºº)");

  const pRes = await fetch(`${FHIR_BASE}/Patient/${patientId}`);
  const patient = await pRes.json();

  const email = patient.telecom?.find(t => t.system === "email")?.value;
  if (!email) return alert("ç—…äººæ²’æœ‰ email");

  const volunteerId = task.owner?.reference?.split("/")[1];
  if (!volunteerId) return alert("Task æ²’æœ‰ owner");

  const communication = {
    resourceType: "Communication",
    status: "completed",
    sent: new Date().toISOString(),
    sender: { reference: `Practitioner/${volunteerId}` },
    payload: [
      { contentString: `æ‚¨çš„è—¥å“é…é€å·²å®Œæˆï¼Œè«‹éµç…§é†«å›‘æœç”¨ã€‚` },
      { contentString: `ğŸ“§ æ‚¨çš„ Email: ${email}` }
    ]
  };

  const cRes = await fetch(`${FHIR_BASE}/Communication`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(communication)
  });

  if (!cRes.ok) throw new Error("Communication å»ºç«‹å¤±æ•—");
  console.log("âœ” Communication å·²å»ºç«‹");
}

/* ------------------------------ */
document.getElementById("logoutBtn").onclick = async () => {
  await fetch("/api/logout", { method: "POST", credentials: "include" });
  localStorage.clear();
  window.location.href = "/login.html";
};

loadUserInfo();
loadMyTasks();
/* ------------------------------ */
</script>



</body>
</html>