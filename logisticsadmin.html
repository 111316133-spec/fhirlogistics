<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ç‰©æµç®¡ç†å“¡å¾Œå° - é…é€å“¡å¯©æ ¸</title>

<style>
body {
  font-family: Arial, sans-serif;
  background-color: #f5f7ff;
  color: #333333;
  padding: 20px;
}

h2 {
  color: #4b4bff;
  margin-bottom: 10px;
}

hr {
  border: 0;
  border-top: 1px solid #d0d4e6;
  margin: 20px 0;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  margin-bottom: 20px;
}

th, td {
  padding: 10px;
  text-align: left;
  border: 1px solid #d0d4e6;
}

th {
  background-color: #6c63ff;
  color: #ffffff;
}

tbody tr:nth-child(even) {
  background-color: #eef0ff;
}

tbody tr:nth-child(odd) {
  background-color: #ffffff;
}

button {
  background-color: #6c63ff;
  color: #ffffff;
  border: none;
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s;
}

button:hover {
  background-color: #5750d1;
}

#errorMsg {
  color: #ff4d4d;
}

#createMsg {
  color: #28a745;
}

span {
  font-weight: bold;
}

p {
  margin-bottom: 10px;
}

.org-info {
  background-color: #eef0ff;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  border-left: 4px solid #6c63ff;
}
</style>

</head>
<body>

<h2>ç‰©æµç®¡ç†å“¡ç®¡ç†</h2>

<!-- ç‰©æµå…¬å¸è³‡è¨Š -->
<div class="org-info">
  <p>ç›®å‰ç™»å…¥çš„ç®¡ç†å“¡ï¼š<span id="adminName">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</span></p>
  <p>æ‰€å±¬ç‰©æµå…¬å¸ï¼š<span id="orgName">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</span></p>
  <p>å…¬å¸åœ°å€ï¼š<span id="orgAddress">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</span></p>
</div>

<div style="text-align:right; margin-bottom: 10px;">
  <button id="logoutBtn">ç™»å‡º</button>
</div>
<hr>




<h2>é…é€å“¡ç®¡ç†</h2>

<table>
<thead>
  <tr>
    <th>å§“å</th>
    <th>è·ä½</th>
    <th>äººå“¡ ID</th>
    <th>è·ä½ ID</th>
    <th>ç‹€æ…‹</th>
    <th>æ“ä½œ</th>
  </tr>
</thead>
<tbody id="allCourierTable"></tbody>
</table>
<h2>é…é€è«‹æ±‚æ¸…å–®</h2>
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>é¡åˆ¥</th>
      <th>ç‰©å“åç¨±</th>
      <th>æ•¸é‡</th>
      <th>ç‹€æ…‹</th>
      <th>ç™¼é€çµ„ç¹”</th>
      <th>æ”¶ä»¶çµ„ç¹”</th>
       <th>æ‰€å±¬é†«é™¢</th> 
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody id="supplyRequestTableBody">
    <tr><td colspan="7">è¼‰å…¥ä¸­...</td></tr>
  </tbody>
</table>
<h2>é…é€ä»»å‹™æ¸…å–®</h2>
<table>
  <thead>
    <tr>
      <th>Task ID</th>
      <th>SupplyRequest</th>
      
      <th>è—¥å“åç¨±</th>
      <th>æ•¸é‡</th>
      <th>æŒ‡æ´¾é…é€å“¡</th>
      <th>ä»»å‹™ç‹€æ…‹</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody id="taskTableBody">
    <tr><td colspan="7">è¼‰å…¥ä¸­...</td></tr>
  </tbody>
</table>


<script>
const FHIR = "http://203.64.84.204:8080/fhir";

let adminPractitionerId = null;
let adminOrganizationId = null;

/* -------------------------------------------------------
   ğŸ”¹ A. åŸºæœ¬å·¥å…·å‡½å¼ï¼šæŸ¥ Person åå­—
------------------------------------------------------- */
async function getPersonNameFromPractitioner(practitionerId) {
  try {
    const url = `${FHIR}/Person?link=Practitioner/${practitionerId}`;
    const res = await fetch(url);

    if (!res.ok) return "ï¼ˆæœªçŸ¥å§“åï¼‰";

    const bundle = await res.json();
    if (!bundle.entry || bundle.entry.length === 0) return "ï¼ˆæœªå»ºç«‹ Personï¼‰";

    const person = bundle.entry[0].resource;

    return (
      person?.name?.[0]?.text ||
      person?.name?.[0]?.family ||
      person?.name?.[0]?.given?.[0] ||
      "ï¼ˆæœªæä¾›ï¼‰"
    );
  } catch {
    return "ï¼ˆæŸ¥è©¢éŒ¯èª¤ï¼‰";
  }
}

/* -------------------------------------------------------
   ğŸ”¹ B. ç®¡ç†å“¡ç™»å…¥è³‡è¨Š
------------------------------------------------------- */
async function loadAdminInfo() {
  try {
    const res = await fetch("/api/organizations", { credentials: "include" });
    const list = await res.json();

    if (!list.length) {
      alert("æœªç™»å…¥ï¼Œè«‹é‡æ–°ç™»å…¥ï¼");
      location.href = "/login.html";
      return;
    }

    const admin = list[0];
    adminPractitionerId = admin.practitionerId;
    adminOrganizationId = admin.orgId;
    console.log("ğŸ§© ç›®å‰ç®¡ç†å“¡çš„ adminOrganizationId =", adminOrganizationId);

    // å–å¾—ç®¡ç†å“¡å§“å
    const adminName = await getPersonNameFromPractitioner(adminPractitionerId);
    document.getElementById("adminName").innerText = `${adminName}ï¼ˆ${admin.roleDisplay}ï¼‰`;

    // å–å¾—ç‰©æµå…¬å¸è³‡è¨Š
    await loadOrganizationInfo();

    loadCouriers();
  } catch (e) {
    console.error("ç„¡æ³•å–å¾—ç®¡ç†å“¡è³‡è¨Š:", e);
    alert("éŒ¯èª¤ï¼šç„¡æ³•å–å¾—ç®¡ç†å“¡è³‡è¨Š");
  }
}

/* -------------------------------------------------------
   ğŸ”¹ B1. è¼‰å…¥ç‰©æµå…¬å¸è³‡è¨Š
------------------------------------------------------- */
async function loadOrganizationInfo() {
  if (!adminOrganizationId) return;

  try {
    // å–å¾—çµ„ç¹”è©³ç´°è³‡è¨Š
    const orgRes = await fetch(`${FHIR}/Organization/${adminOrganizationId}`);
    if (!orgRes.ok) {
      console.error("ç„¡æ³•å–å¾—çµ„ç¹”è³‡è¨Š");
      return;
    }

    const organization = await orgRes.json();
    
    // é¡¯ç¤ºå…¬å¸åç¨±
    const orgName = organization.name || "ï¼ˆæœªæä¾›å…¬å¸åç¨±ï¼‰";
    document.getElementById("orgName").innerText = orgName;
    
    // æ ¼å¼åŒ–åœ°å€
    const address = organization.address?.[0];
    let addressText = "ï¼ˆæœªæä¾›åœ°å€ï¼‰";
    
    if (address) {
      const addressParts = [];
      
      // å°ç£åœ°å€æ ¼å¼ï¼šç¸£å¸‚ > å€ > è¡—é“
      if (address.city) addressParts.push(address.city);
      if (address.district) addressParts.push(address.district);
      if (address.line) {
        // line æ˜¯é™£åˆ—ï¼Œåˆä½µæ‰€æœ‰è¡Œ
        addressParts.push(address.line.join(""));
      }
      if (address.postalCode) addressParts.push(`éƒµéå€è™Ÿï¼š${address.postalCode}`);
      
      addressText = addressParts.join(" ");
    }
    
    document.getElementById("orgAddress").innerText = addressText;
    
  } catch (error) {
    console.error("è¼‰å…¥çµ„ç¹”è³‡è¨ŠéŒ¯èª¤:", error);
    document.getElementById("orgName").innerText = "ï¼ˆè¼‰å…¥å¤±æ•—ï¼‰";
    document.getElementById("orgAddress").innerText = "ï¼ˆè¼‰å…¥å¤±æ•—ï¼‰";
  }
}

document.getElementById("logoutBtn").onclick = async () => {
  await fetch("/api/logout", {
    method: "POST",
    credentials: "include"
  });

  localStorage.clear();   // æ¸…é™¤ emailã€org ç­‰æ±è¥¿
  window.location.href = "/"; // å›é¦–é æˆ– login é 
};

/* -------------------------------------------------------
   ğŸ”¹ C. å¾…å¯©æ ¸é…é€å“¡åˆ—è¡¨
------------------------------------------------------- */
async function loadCouriers() {
  if (!adminOrganizationId) return;

  const url = `${FHIR}/PractitionerRole?organization=Organization/${adminOrganizationId}&_count=200`;
  console.log("ğŸ” æŸ¥è©¢é…é€å“¡ URL:", url);

  const res = await fetch(url);
  const bundle = await res.json();

  const tbody = document.getElementById("courierTableBody");
  tbody.innerHTML = "";

  if (!bundle.entry || bundle.entry.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6">æ²’æœ‰é…é€å“¡è§’è‰²</td></tr>`;
    return;
  }

  const waiting = bundle.entry.filter(e => e.resource.active === false);

  if (waiting.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„ç‰©æµé…é€å“¡</td></tr>`;
    return;
  }

  for (const e of waiting) {
    const role = e.resource;
    const roleId = role.id;
    const practitionerId = role.practitioner.reference.replace("Practitioner/", "");

    const name = await getPractitionerName(practitionerId);

    const roleDisplay =
      role.code?.[0]?.coding?.[0]?.display ||
      role.code?.[0]?.coding?.[0]?.code ||
      "ï¼ˆæœªæä¾›è·ä½ï¼‰";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${name}</td>
      <td>${roleDisplay}</td>
      <td>${practitionerId}</td>
      <td>${roleId}</td>
      <td><span style="color:red;">å¾…å¯©æ ¸</span></td>
      <td>
        <button onclick="approve('${roleId}')">âœ” åŒæ„</button>
        <button class="reject" onclick="rejectRole('${roleId}', '${practitionerId}')">âœ– æ‹’çµ•</button>
      </td>
    `;
    tbody.appendChild(tr);
  }
}

/* ğŸ”¹ å·¥å…·ï¼šæŸ¥ Practitioner åå­— */
async function getPractitionerName(practitionerId) {
  try {
    const url = `${FHIR}/Person?link=Practitioner/${practitionerId}`;
    const res = await fetch(url);
    if (!res.ok) return "ï¼ˆæœªçŸ¥å§“åï¼‰";

    const bundle = await res.json();
    if (!bundle.entry || bundle.entry.length === 0) return "ï¼ˆæœªå»ºç«‹ Personï¼‰";

    const person = bundle.entry[0].resource;

    return (
      person?.name?.[0]?.text ||
      person?.name?.[0]?.family ||
      person?.name?.[0]?.given?.[0] ||
      "ï¼ˆæœªæä¾›ï¼‰"
    );
  } catch {
    return "ï¼ˆéŒ¯èª¤ï¼‰";
  }
}

/* ğŸ”¹ å¯©æ ¸é€šé */
async function approve(roleId) {
  const res = await fetch(`${FHIR}/PractitionerRole/${roleId}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json-patch+json" },
    body: JSON.stringify([{ op: "replace", path: "/active", value: true }])
  });

  if (!res.ok) {
    alert("å¯©æ ¸å¤±æ•—ï¼");
    return;
  }

  alert("âœ” å¯©æ ¸é€šéï¼");
  loadCouriers();
}

/* ğŸ”¹ æ‹’çµ• + åˆªé™¤ */
async function rejectRole(roleId, practitionerId) {
  const reason = prompt("æ‹’çµ•ç†ç”±ï¼š");
  if (!reason) return;

  await fetch(`${FHIR}/PractitionerRole/${roleId}`, { method: "DELETE" });
  await fetch(`${FHIR}/Practitioner/${practitionerId}`, { method: "DELETE" });

  alert("âœ– å·²æ‹’çµ•ä¸¦åˆªé™¤é…é€å“¡");
  loadCouriers();
}

/* -------------------------------------------------------
   ğŸ”¹ D. æ‰€æœ‰é…é€å“¡ç®¡ç†ï¼ˆå•Ÿç”¨/åœç”¨ï¼‰
------------------------------------------------------- */
async function loadAllCouriers() {
  if (!adminOrganizationId) return;

  const url = `${FHIR}/PractitionerRole?organization=Organization/${adminOrganizationId}&_count=200`;
  const res = await fetch(url);
  const bundle = await res.json();

  const tbody = document.getElementById("allCourierTable");
  tbody.innerHTML = "";

  if (!bundle.entry || bundle.entry.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6">æ²’æœ‰é…é€å“¡è§’è‰²</td></tr>`;
    return;
  }

  for (const e of bundle.entry) {
    const role = e.resource;
    const roleCode = role.code?.[0]?.coding?.[0]?.code || "";
    if (roleCode !== "LogisticsCourier") continue;

    const roleId = role.id;
    const practitionerId = role.practitioner.reference.replace("Practitioner/", "");
    const name = await getPractitionerName(practitionerId);

    const roleDisplay =
      role.code?.[0]?.coding?.[0]?.display ||
      role.code?.[0]?.coding?.[0]?.code ||
      "ï¼ˆæœªæä¾›è·ä½ï¼‰";

    const activeText = role.active
      ? `<span style="color:green;">å•Ÿç”¨</span>`
      : `<span style="color:red;">åœç”¨</span>`;

    const actionBtn = role.active
      ? `<button onclick="setRoleStatus('${roleId}', false)">åœç”¨</button>`
      : `<button onclick="setRoleStatus('${roleId}', true)">å•Ÿç”¨</button>`;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${name}</td>
      <td>${roleDisplay}</td>
      <td>${practitionerId}</td>
      <td>${roleId}</td>
      <td>${activeText}</td>
      <td>${actionBtn}</td>
    `;
    tbody.appendChild(tr);
  }
}

/* æ”¹ active */
async function setRoleStatus(roleId, status) {
  const confirmMsg = status ? "ç¢ºå®šè¦å•Ÿç”¨ï¼Ÿ" : "ç¢ºå®šè¦åœç”¨ï¼Ÿ";
  if (!confirm(confirmMsg)) return;

  const res = await fetch(`${FHIR}/PractitionerRole/${roleId}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json-patch+json" },
    body: JSON.stringify([{ op: "replace", path: "/active", value: status }])
  });

  if (!res.ok) {
    alert("æ›´æ–°å¤±æ•—ï¼");
    return;
  }

  alert("ç‹€æ…‹å·²æ›´æ–°ï¼");
  loadAllCouriers();
  loadCouriers();
}

/* -------------------------------------------------------
   ğŸ”¹ E. æœ¬çµ„ç¹” SupplyRequestï¼ˆåªç¯©é¸ supplierï¼‰
------------------------------------------------------- */
async function loadOrganizationSupplyRequests() {
  if (!adminOrganizationId) return;

  // === A. å…ˆæŠŠæ‰€æœ‰ organization æ’ˆèµ·ä¾†åšæˆå¿«å– ===
  const orgRes = await fetch(`${FHIR}/Organization?_count=200`);
  const orgBundle = await orgRes.json();
  const orgMap = {};

  if (orgBundle.entry) {
    orgBundle.entry.forEach(e => {
      const org = e.resource;
      const addr = org.address?.[0];
      const fullAddr = addr ? `${addr.country || ''}${addr.state || ''}${addr.city || ''}${addr.district || ''}${addr.line?.join('') || ''}` : "-";
      orgMap[`Organization/${org.id}`] = fullAddr;
    });
  }

  // === B. æ’ˆ SupplyRequest ===
  const url = `${FHIR}/SupplyRequest?_count=200`;
  const res = await fetch(url);
  const bundle = await res.json();

  const tbody = document.getElementById("supplyRequestTableBody");
  tbody.innerHTML = "";

  if (!bundle.entry || bundle.entry.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9">ç›®å‰æ²’æœ‰ SupplyRequest</td></tr>`;
    return;
  }

  console.log("æˆ‘çš„ç‰©æµçµ„ç¹” ID =", adminOrganizationId);

  // åªæŠ“ã€Œä¾›æ‡‰è€…æ˜¯æˆ‘é€™å€‹ç‰©æµçµ„ç¹”ã€çš„ SR
  const list = bundle.entry
    .map(e => e.resource)
    .filter(sr =>
      sr.supplier?.some(s => s.reference === `Organization/${adminOrganizationId}`)
    )
    // === C. ç‰©å“åç¨±åªé¡¯ç¤ºè—¥å“ ===
    .filter(sr =>
      (sr.itemCodeableConcept?.text || "").includes("è—¥")
    )
    .sort((a, b) => (b.id || '').localeCompare(a.id || ''));
  if (list.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9">æ²’æœ‰å±¬æ–¼æœ¬çµ„ç¹”çš„ SupplyRequest</td></tr>`;
    return;
  }

  for (const sr of list) {
    const supplierAddr = sr.supplier
      ?.map(s => orgMap[s.reference] || s.reference)
      .join(", ") || "-";

    const receiverAddr =
      orgMap[sr.deliverTo?.reference] ||
      sr.deliverTo?.reference ||
      "-";

    // === â˜… æ–°å¢ï¼šé¡¯ç¤º deliverFrom.display ===
    const deliverFromHospital =
      sr.deliverFrom?.display || "-";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${sr.id}</td>
      <td>${sr.category?.text || "-"}</td>
      <td>${sr.itemCodeableConcept?.text || "-"}</td>
      <td>${sr.quantity?.value || "-"} ${sr.quantity?.unit || ""}</td>
      <td>${sr.status || "-"}</td>
      <td>${supplierAddr}</td>
      <td>${receiverAddr}</td>
      <td>${deliverFromHospital}</td> 
      <td><button onclick="createTaskFromSupplyRequest('${sr.id}')">å»ºç«‹ä»»å‹™</button></td>
    `;
    tbody.appendChild(tr);
  }
}


/* -------------------------------------------------------
   ğŸ”¹ F. Task å»ºç«‹èˆ‡åˆ—è¡¨
------------------------------------------------------- */
async function createTaskFromSupplyRequest(supplyRequestId) {

  // 1ï¸âƒ£ å…ˆè®€å– SupplyRequest
  const supplyRes = await fetch(`${FHIR}/SupplyRequest/${supplyRequestId}`);
  const supply = await supplyRes.json();

  const itemCC = supply.itemCodeableConcept;
  const qty = supply.quantity;

  // 2ï¸âƒ£ æº–å‚™ Task Resource
  const taskResource = {
    resourceType: "Task",
    status: "accepted",
    intent: "order",
    code: {
      coding: [
        {
          system: "http://example.org/task-code",
          code: "deliver-medication",
          display: "é…é€è—¥å“"
        }
      ]
    },
    focus: { reference: `SupplyRequest/${supplyRequestId}` },
    requester: { reference: `Practitioner/${adminPractitionerId}` },
    authoredOn: new Date().toISOString(),
    executionPeriod: {
      start: new Date().toISOString(),
      end: new Date(Date.now() + 24 * 3600 * 1000).toISOString()
    },
    note: [{ text: "è«‹ä¾ç…§ä¾›æ‡‰éœ€æ±‚é…é€" }],
    input: []
  };

  // 3ï¸âƒ£ æŠŠ itemCodeableConcept å¡åˆ° Task.input
  if (itemCC) {
    taskResource.input.push({
      type: {
        coding: [
          {
            system: "http://hl7.org/fhir/task-input-type",
            code: "medication",
            display: "Medication Item"
          }
        ]
      },
      valueCodeableConcept: itemCC
    });
  }

  // 4ï¸âƒ£ æŠŠæ•¸é‡å¡åˆ° Task.input
  if (qty) {
    taskResource.input.push({
      type: {
        coding: [
          {
            system: "http://hl7.org/fhir/task-input-type",
            code: "medication-quantity",
            display: "Medication Quantity"
          }
        ]
      },
      valueQuantity: qty
    });
  }

  // 5ï¸âƒ£ å»ºç«‹ Task
  const res = await fetch(`${FHIR}/Task`, {
    method: "POST",
    headers: { "Content-Type": "application/fhir+json" },
    body: JSON.stringify(taskResource)
  });

  if (!res.ok) {
    const errText = await res.text();
    alert("âŒ å»ºç«‹ Task å¤±æ•—ï¼\n" + errText);
    return;
  }

  alert(`âœ” ä»»å‹™å·²å»ºç«‹ (SupplyRequest/${supplyRequestId})`);
}

// ğŸ” è§£æ Task.input å–å¾—è—¥å“åç¨± & æ•¸é‡
function parseTaskMedication(task) {
  let medName = "-";
  let medQty = "-";

  if (task.input) {
    for (const input of task.input) {
      const code = input.type?.coding?.[0]?.code;

      if (code === "medication") {
        medName = input.valueCodeableConcept?.text ||
                  input.valueCodeableConcept?.coding?.[0]?.display || "-";
      }

      if (code === "medication-quantity") {
        medQty = input.valueQuantity?.value || "-";
      }
    }
  }

  return { medName, medQty };
}


async function loadTasks() {
  if (!adminOrganizationId) return;

  const url = `${FHIR}/Task?requester=Practitioner/${adminPractitionerId}&_count=100`;
  const res = await fetch(url);
  const bundle = await res.json();

  const tbody = document.getElementById("taskTableBody");
  tbody.innerHTML = "";

  if (!bundle.entry || bundle.entry.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7">ç›®å‰æ²’æœ‰ Task</td></tr>`;
    return;
  }

  // å–å¾—é…é€å“¡åˆ—è¡¨
  const couriers = [];
  const courierBundle = await fetch(`${FHIR}/PractitionerRole?organization=Organization/${adminOrganizationId}&_count=200`)
    .then(r => r.json());

  if (courierBundle.entry) {
    for (const e of courierBundle.entry) {
      const role = e.resource;
      const roleCode = role.code?.[0]?.coding?.[0]?.code || "";
      if (roleCode !== "LogisticsCourier") continue;

      const id = role.practitioner.reference.replace("Practitioner/", "");
      const name = await getPractitionerName(id);
      couriers.push({ id, name });
    }
  }

  // ç”¢ç”Ÿ Task åˆ—è¡¨
  for (const e of bundle.entry) {
    const task = e.resource;

    // â¬…ï¸ æ–°å¢é€™è¡Œï¼šè§£æ input
    const { medName, medQty } = parseTaskMedication(task);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${task.id}</td>
      <td>${task.focus?.reference || "-"}</td>
      <td>${medName}</td>
      <td>${medQty}</td>
      <td>
        <select id="courier-${task.id}">
          ${couriers.map(c => `<option value="${c.id}">${c.name}</option>`).join("")}
        </select>
        <button onclick="assignCourierToTask('${task.id}', document.getElementById('courier-${task.id}').value)">æŒ‡æ´¾</button>
      </td>
      <td>${task.status || "-"}</td>
      <td><button onclick="viewTaskDetails('${task.id}')">æª¢è¦–</button></td>
    `;
    tbody.appendChild(tr);
  }
}
async function assignCourierToTask(taskId, practitionerId) {

  // 1. å…ˆè®€ Taskï¼Œåˆ¤æ–· owner æ˜¯å¦å­˜åœ¨
  const before = await fetch(`${FHIR}/Task/${taskId}`).then(r => r.json());
  const hasOwner = !!before.owner;

  // 2. å‹•æ…‹æ±ºå®š add æˆ– replace
  const ops = [
    {
      op: hasOwner ? "replace" : "add",
      path: "/owner",
      value: { reference: `Practitioner/${practitionerId}` }
    }
  ];

  // 3. ç™¼é€ PATCH
  const res = await fetch(`${FHIR}/Task/${taskId}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json-patch+json" },
    body: JSON.stringify(ops)
  });

  // 4. å…ˆè®€ textï¼ˆé¿å… stream éŒ¯èª¤ï¼‰
  const text = await res.text();
  console.log("PATCH result:", text);

  if (!res.ok) {
    alert("æŒ‡æ´¾å¤±æ•—ï¼\n" + text);
    return;
  }

  alert("âœ” å·²æŒ‡æ´¾é…é€å“¡");
  loadTasks();
}


// è£œå›ç¼ºå¤±çš„ function
function viewTaskDetails(taskId) {
  window.open(`${FHIR}/Task/${taskId}`, "_blank");
}
/* -------------------------------------------------------
   ğŸ”¹ G. å•Ÿå‹•æµç¨‹ï¼ˆåŸ·è¡Œé †åºï¼‰
------------------------------------------------------- */
async function start() {
  await loadAdminInfo();          // å…ˆç­‰ç®¡ç†å“¡è³‡è¨Šè¼‰å…¥
  loadTasks();                    // æ‰æœ‰ adminPractitionerId
  loadOrganizationSupplyRequests(); // æ‰æœ‰ adminOrganizationId
  loadAllCouriers();              // ä¸éœ€è¦å»¶é²
}
start();
</script>

</body>
</html>