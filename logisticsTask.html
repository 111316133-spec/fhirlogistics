<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ç‰©æµé…é€å“¡å¾Œå°</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f7ff;
      color: #333333;
      padding: 20px;
    }

    h2 {
      color: #4b4bff;
      margin-bottom: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border: 1px solid #d0d4e6;
    }

    th {
      background-color: #6c63ff;
      color: #ffffff;
    }

    tbody tr:nth-child(even) {
      background-color: #eef0ff;
    }

    tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }

    button {
      background-color: #6c63ff;
      color: #ffffff;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #5750d1;
    }
  </style>
</head>
<body>

<h2>ç‰©æµé…é€å“¡å¾Œå°</h2>
<button id="logoutBtn" style="float:right; background:#2453ec;">ç™»å‡º</button>

<p>ç›®å‰ç™»å…¥é…é€å“¡ï¼š<span id="courierName">è¼‰å…¥ä¸­â€¦</span></p>
<hr>

<h2>æˆ‘çš„é…é€ä»»å‹™</h2>
<table>
  <thead>
    <tr>
      <th>Task ID</th>
      <th>SupplyRequest</th>
      <th>è—¥å“åç¨±</th>
      <th>æ•¸é‡</th>
      <th>ä»»å‹™ç‹€æ…‹</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody id="courierTaskTableBody">
    <tr><td colspan="6">è¼‰å…¥ä¸­...</td></tr>
  </tbody>
</table>

<script>
const FHIR_204 = "http://203.64.84.204:8080/fhir";
const FHIR_209 = "http://203.64.84.209:8080/fhir";
let courierPractitionerId = null;

// ----------------------
// å–å¾—ç™»å…¥é…é€å“¡è³‡è¨Š
// ----------------------
async function loadCourierInfo() {
  try {
    const res = await fetch("/api/organizations", { credentials: "include" });
    const list = await res.json();

    if (!list.length) {
      alert("æœªç™»å…¥æˆ–æ²’æœ‰å°æ‡‰çš„ç‰©æµè§’è‰²ï¼");
      location.href = "/login.html";
      return;
    }

    const admin = list[0];
    courierPractitionerId = admin.practitionerId;

    const personName = await getPersonNameByPractitioner(courierPractitionerId);
    document.getElementById("courierName").innerText = personName;

    loadCourierTasks(courierPractitionerId);

  } catch (err) {
    console.error("âŒ ç„¡æ³•å–å¾—ç™»å…¥è³‡è¨Š", err);
    alert("ç„¡æ³•å–å¾—ç™»å…¥è³‡è¨Š");
  }
}
document.getElementById("logoutBtn").onclick = async () => {
  await fetch("/api/logout", {
    method: "POST",
    credentials: "include"
  });

  localStorage.clear();  // å¦‚æœä½ æœ‰å„²å­˜ email / orgId
  window.location.href = "/login.html"; // å›é¦–é æˆ–ç™»å…¥é 
};
// ----------------------
// ç”¨ PractitionerId æ‰¾ Person.name
// ----------------------
async function getPersonNameByPractitioner(practitionerId) {
  const url = `${FHIR_204}/Person?link=${encodeURIComponent("Practitioner/" + practitionerId)}`;
  const res = await fetch(url);
  const bundle = await res.json();

  if (!bundle.entry || !bundle.entry.length) return "(æœªå‘½åé…é€å“¡)";
  const person = bundle.entry[0].resource;
  return person.name?.[0]?.text || "(æœªå‘½åé…é€å“¡)";
}

// ----------------------
// è¼‰å…¥ä»»å‹™åˆ—è¡¨
// ----------------------
async function loadCourierTasks(practitionerId) {
  const url = `${FHIR_204}/Task?owner=Practitioner/${practitionerId}&_count=100`;
  const res = await fetch(url);
  const bundle = await res.json();

  const tbody = document.getElementById("courierTaskTableBody");
  tbody.innerHTML = "";

  if (!bundle.entry || bundle.entry.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6">ç›®å‰æ²’æœ‰ä»»å‹™</td></tr>`;
    return;
  }

  for (const e of bundle.entry) {
    const task = e.resource;

    let medName = "-";
    let medQty = "-";

    if (Array.isArray(task.input)) {
      for (const input of task.input) {
        const code = input.type?.coding?.[0]?.code;
        if (code === "medication" && input.valueCodeableConcept) {
          medName = input.valueCodeableConcept.text || input.valueCodeableConcept.coding?.[0]?.display || "-";
        }
        if (code === "medication-quantity" && input.valueQuantity) {
          medQty = input.valueQuantity.value || "-";
        }
      }
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${task.id}</td>
      <td>${task.focus?.reference || "-"}</td>
      <td>${medName}</td>
      <td>${medQty}</td>
      <td>${task.status || "-"}</td>
      <td>
        <button onclick="updateTaskStatus('${task.id}', 'in-progress')">é€²è¡Œä¸­</button>
        <button onclick='completeTaskWithActions("${task.id}")'>å®Œæˆ</button>
      </td>
    `;
    tbody.appendChild(tr);
  }
}

// ----------------------
// æ›´æ–° Task ç‹€æ…‹
// ----------------------
async function updateTaskStatus(taskId, status) {
  const res = await fetch(`${FHIR_204}/Task/${taskId}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json-patch+json" },
    body: JSON.stringify([{ op: "replace", path: "/status", value: status }])
  });
  if (!res.ok) { alert("æ›´æ–°ä»»å‹™ç‹€æ…‹å¤±æ•—ï¼"); return; }
  alert(`âœ” ä»»å‹™ç‹€æ…‹æ›´æ–°ç‚º ${status}`);
  loadCourierTasks(courierPractitionerId);
}

// ----------------------
// å®Œæˆä»»å‹™ä¸¦å»ºç«‹ SupplyDelivery & é€šçŸ¥
// ----------------------

async function completeTaskWithActions(taskId) {
  // --- å–å¾— Task ---
  let task;
  try {
    const res = await fetch(`${FHIR_204}/Task/${taskId}`);
    task = await res.json();
  } catch (err) {
    console.error("âŒ å–å¾— Task å¤±æ•—", err);
    return;
  }

  const supplyRequestRef = task.focus?.reference;
  if (!supplyRequestRef) {
    alert("âŒ Task æ²’æœ‰ focus SupplyRequest");
    return;
  }

  // --- å–å¾— SupplyRequest ---
  let supplyRequest;
  let medicationName = "è—¥å“";

  let deliverToOrg = null;
  let deliverFromOrg = null;
  let supplierOrg = null;

  try {
    const res = await fetch(`${FHIR_204}/${supplyRequestRef}`);
    supplyRequest = await res.json();

    medicationName = supplyRequest.itemCodeableConcept?.text || medicationName;

    deliverToOrg   = supplyRequest.deliverTo;
    deliverFromOrg = supplyRequest.deliverFrom;
    supplierOrg    = supplyRequest.supplier?.[0];
  } catch (err) {
    console.error("âŒ å–å¾— SupplyRequest å¤±æ•—", err);
    return;
  }

  // ----------------------------
  // å»ºç«‹ deliverTo â†’ Location
  // ----------------------------
  let locationRef;

  if (!deliverToOrg || !deliverToOrg.reference) {
    alert("âŒ SupplyRequest ç¼ºå°‘ deliverTo");
    return;
  }

  const deliverToRef = deliverToOrg.reference; 

  try {
    const locRes = await fetch(
      `${FHIR_204}/Location?managingOrganization=${encodeURIComponent(deliverToRef)}`
    );
    const locBundle = await locRes.json();

    if (locBundle.entry?.length) {
      locationRef = `Location/${locBundle.entry[0].resource.id}`;
    } else {
      const orgRes = await fetch(`${FHIR_204}/${deliverToRef}`);
      const orgData = await orgRes.json();
      const locName = orgData.name || deliverToOrg.display || "é…é€ç›®çš„åœ°";

      const newLocRes = await fetch(`${FHIR_204}/Location`, {
        method: "POST",
        headers: { "Content-Type": "application/fhir+json" },
        body: JSON.stringify({
          resourceType: "Location",
          name: locName,
          managingOrganization: { reference: deliverToRef },
          description: "é…é€ç›®çš„åœ°"
        })
      });

      const newLoc = await newLocRes.json();
      locationRef = `Location/${newLoc.id}`;
    }
  } catch (err) {
    console.error("âŒ å–å¾—æˆ–å»ºç«‹ Location å¤±æ•—", err);
    alert("âŒ ç„¡æ³•å–å¾—æˆ–å»ºç«‹é…é€ Location");
    return;
  }

  // ----------------------------
  // å»ºç«‹ SupplyDelivery
  // ----------------------------
  const supplyDelivery = {
    resourceType: "SupplyDelivery",
    status: "completed",
    identifier: supplyRequest.identifier?.map(id => ({
      system: id.system || "http://example.org/patient-email",
      value: id.value
    })),
    suppliedItem: {
      itemCodeableConcept: supplyRequest.itemCodeableConcept,
      quantity: supplyRequest.quantity
    },
    supplier: supplierOrg
      ? [supplierOrg]
      : [{ reference: "Organization/2096", display: "ç‰©æµå…¬å¸" }],
    occurrenceDateTime: new Date().toISOString(),
    destination: { reference: locationRef },
    origin: deliverFromOrg
      ? { reference: deliverFromOrg.reference, display: deliverFromOrg.display }
      : undefined,
    receiver: [
      { reference: `Practitioner/${courierPractitionerId}`, display: "é…é€å“¡" }
    ],
    basedOn: [{ reference: supplyRequestRef }]
  };

  let supplyDeliveryId;
  try {
    const res = await fetch(`${FHIR_204}/SupplyDelivery`, {
      method: "POST",
      headers: { "Content-Type": "application/fhir+json" },
      body: JSON.stringify(supplyDelivery)
    });
    const result = await res.json();
    supplyDeliveryId = result.id;
    console.log("âœ… SupplyDelivery å»ºç«‹æˆåŠŸ ID:", supplyDeliveryId);
  } catch (err) {
    console.error("âŒ å»ºç«‹ SupplyDelivery ç™¼ç”ŸéŒ¯èª¤", err);
    return;
  }

  // ----------------------------
  // é€šçŸ¥ç—…äºº (ä½¿ç”¨ SupplyRequest.identifier.email)
  // ----------------------------
 // é€šçŸ¥ç—…äºº (email ç›´æ¥æ”¾åœ¨ payload)
const patientEmail = supplyRequest.identifier?.find(id => id.system === "http://example.org/patient-email")?.value;

if (patientEmail) {
  const communicationForPatient = {
    resourceType: "Communication",
    status: "completed",
    sent: new Date().toISOString(),
    sender: { reference: `Practitioner/${courierPractitionerId}` },
    payload: [
      {
        contentString: `âœ… æ‚¨çš„è—¥å“ã€Œ${medicationName}ã€å·²æˆåŠŸé…é€åˆ°æŒ‡å®šç¤¾å€å°å•†åº—ï¼Œé…é€å–®è™Ÿ: ${supplyDeliveryId},å¯ç”³è«‹é…é€è—¥å“åˆ°å®¶`
      },
      {
        contentString: `ğŸ“§ æ‚¨çš„ Email: ${patientEmail}`
      }
    ]
  };

  try {
    await fetch(`${FHIR_204}/Communication`, {
      method: "POST",
      headers: { "Content-Type": "application/fhir+json" },
      body: JSON.stringify(communicationForPatient)
    });
    console.log("âœ… å·²å»ºç«‹ Communicationï¼Œpayload åŒ…å«ç—…äºº email:", patientEmail);
  } catch (err) {
    console.error("âŒ å»ºç«‹ Communication å¤±æ•—", err);
  }
}


  // ----------------------------
  // é€šçŸ¥è—¥å¸«
  // ----------------------------
  const pharmacistPractitionerId = "1513";
  const courierPractitionerId209 = "1514";

  const communicationForPharmacist = {
    resourceType: "Communication",
    status: "completed",
    sent: new Date().toISOString(),
    subject: { reference: "Patient/patient-young" },
    recipient: [{ reference: `Practitioner/${pharmacistPractitionerId}` }],
    sender: { reference: `Practitioner/${courierPractitionerId209}` },
    payload: [
      {
        contentString: `âœ… é…é€å–® ${supplyDeliveryId} å·²å®Œæˆï¼Œè—¥å“ã€Œ${medicationName}ã€å·²æˆåŠŸé€é”`
      }
    ]
  };

  try {
    await fetch(`${FHIR_209}/Communication`, {
      method: "POST",
      headers: { "Content-Type": "application/fhir+json" },
      body: JSON.stringify(communicationForPharmacist)
    });
  } catch (err) {
    console.error("âŒ é€šçŸ¥è—¥å¸«å¤±æ•—", err);
  }

  // ----------------------------
  // æ›´æ–° Task
  // ----------------------------
  try {
    await fetch(`${FHIR_204}/Task/${taskId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json-patch+json" },
      body: JSON.stringify([{ op: "replace", path: "/status", value: "completed" }])
    });

    alert("âœ” é…é€å®Œæˆï¼Œå·²å»ºç«‹ SupplyDelivery ä¸¦é€šçŸ¥ç›¸é—œäººå“¡ã€‚");
  } catch (err) {
    console.error("âŒ æ›´æ–° Task å¤±æ•—", err);
  }

  loadCourierTasks(courierPractitionerId);
}


// ----------------------
// åˆå§‹åŒ–
// ----------------------
loadCourierInfo();
</script>

</body>
</html>
