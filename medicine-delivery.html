<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>ç”³è«‹é€è—¥åˆ°åºœ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', Arial, sans-serif;
        }

        body {
            background: #eef2ff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .card {
            max-width: 700px;
            width: 100%;
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
        }

        .header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .header-icon {
            font-size: 24px;
            margin-right: 10px;
            color: #4c6fff;
        }

        h2 {
            margin-top: 0;
            font-size: 20px;
            color: #2c3e50;
        }

        label {
            display: block;
            margin-top: 12px;
            font-size: 14px;
            font-weight: 500;
            color: #34495e;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 4px;
            border-radius: 8px;
            border: 1px solid #ccd2ff;
            font-size: 14px;
            box-sizing: border-box;
            background: #fafbff;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4c6fff;
            box-shadow: 0 0 0 2px rgba(76, 111, 255, 0.2);
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .btn {
            padding: 12px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            margin-top: 18px;
            font-size: 15px;
            transition: background-color 0.2s, transform 0.1s;
            font-weight: 500;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #4c6fff;
            color: #fff;
        }

        .btn-primary:hover {
            background: #3a5bed;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
            margin-left: 8px;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219653;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .status {
            font-size: 13px;
            margin-top: 10px;
            min-height: 18px;
            padding: 8px;
            border-radius: 4px;
        }

        .ok {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .err {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .loading {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }

        .patient-info {
            background: #f0f4ff;
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 13px;
            border-left: 3px solid #4c6fff;
        }

        .required::after {
            content: " *";
            color: #e74c3c;
        }

        .info-text {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
        }

        .welcome-message {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8faff;
            border-radius: 8px;
            text-align: center;
        }

        .medication-info {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            margin-top: 5px;
            border-left: 3px solid #4caf50;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4c6fff;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 8px;
        }

        .medication-details {
            background: #f0f8ff;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #d1e7ff;
        }

        .detail-row {
            display: flex;
            margin-bottom: 5px;
        }

        .detail-label {
            font-weight: 600;
            min-width: 100px;
            color: #2c3e50;
        }

        .detail-value {
            color: #34495e;
        }

        @media (max-width: 480px) {
            .row {
                grid-template-columns: 1fr;
            }
            
            .btn {
                width: 100%;
                margin-left: 0;
                margin-top: 10px;
            }
            
            .card {
                padding: 16px;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .detail-row {
                flex-direction: column;
            }
            
            .detail-label {
                min-width: auto;
                margin-bottom: 2px;
            }
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="header">
            <div class="header-icon">ğŸ’Š</div>
            <h2>ç”³è«‹é…é€è—¥å“åˆ°å®¶</h2>
        </div>
       <!-- === è—¥å“é¸æ“‡å€å¡Š === -->
<div class="form-section">
    <div class="section-title">
        <i>ğŸ’Š</i> é¸æ“‡ä½ çš„è—¥å“
    </div>
    <label class="required">é¸æ“‡è—¥å“é…é€è¨˜éŒ„</label>
    <select id="supplyDeliverySelect">
        <option value="">è¼‰å…¥ä¸­...</option>
    </select>
</div>
        <div>
            <button class="btn btn-primary" onclick="submitRequest()">ç”³è«‹é…é€è—¥å“åˆ°å®¶</button>
        </div>
        <!-- å°èˆªæŒ‰éˆ• -->
        <div class="nav-buttons">
            <button class="btn btn-success" onclick="goToPatientPage()">ğŸ‘¤ å€‹äººè³‡æ–™ç®¡ç†</button>
        </div>

        <div id="status" class="status"></div>
    </div>
<script>
const baseUrl = "http://203.64.84.204:8080/fhir";   // â­ å…¨åŸŸå…±ç”¨ï¼Œåªå¯«ä¸€æ¬¡
let currentPatientEmail = "";

// åˆå§‹åŒ–ç—…äºº ID èˆ‡ email
async function initPatientId() {
    try {
        const res = await fetch("/api/person", { credentials: "include" });
        if (!res.ok) throw new Error("å–å¾— Person è³‡æ–™å¤±æ•—");

        const data = await res.json();
        if (data.patientId) localStorage.setItem("patientId", data.patientId);
        if (data.email) currentPatientEmail = data.email;

        // æ›´æ–°æ­¡è¿è¨Šæ¯
        const welcome = document.querySelector('.welcome-message');
        if (welcome) {
            welcome.textContent = `æ­¡è¿ ${data.name || 'ä½¿ç”¨è€…'} (${currentPatientEmail})`;
        }

        await loadCompletedSupplyDeliveries();
    } catch (err) {
        console.error("âŒ ç„¡æ³•åˆå§‹åŒ– patientId", err);
        document.getElementById("supplyDeliverySelect").innerHTML = `<option value="">è¼‰å…¥å¤±æ•—</option>`;
    }
}

// å–å¾—ç—…äººçš„å·²å®Œæˆé…é€ç´€éŒ„
async function loadCompletedSupplyDeliveries() {
    const select = document.getElementById("supplyDeliverySelect");
    select.innerHTML = `<option value="">è¼‰å…¥ä¸­...</option>`;

    try {
        const res = await fetch(`${baseUrl}/SupplyDelivery`);
        if (!res.ok) throw new Error("ç„¡æ³•å–å¾— SupplyDelivery");

        const data = await res.json();
        let deliveries = data.entry?.map(e => e.resource) ?? [];

        // éæ¿¾ï¼šå·²å®Œæˆ & identifier åŒ…å«ç—…äºº email
        deliveries = deliveries.filter(d => 
            d.status === "completed" &&
            d.identifier?.some(id => id.value === currentPatientEmail)
        );

        if (deliveries.length === 0) {
            select.innerHTML = `<option value="">å°šç„¡å®Œæˆé…é€ç´€éŒ„</option>`;
            return;
        }

        // ç”Ÿæˆé¸é …
        select.innerHTML = `<option value="">è«‹é¸æ“‡é…é€ç´€éŒ„</option>`;
        deliveries.forEach(d => {
            const itemName = d.suppliedItem?.itemCodeableConcept?.text || "æœªçŸ¥è—¥å“";
            const quantity = d.suppliedItem?.quantity?.value ?? 1;
            const optionText = `${itemName} - ${quantity} åŒ… (${new Date(d.occurrenceDateTime).toLocaleDateString()})`;
            select.innerHTML += `<option value="${d.id}">${optionText}</option>`;
        });

    } catch (err) {
        console.error("âŒ å–å¾—é…é€ç´€éŒ„å¤±æ•—", err);
        select.innerHTML = `<option value="">è¼‰å…¥å¤±æ•—</option>`;
    }
}

// å»ºç«‹æˆ–è£œå…¨ SupplyRequest
async function submitRequest() {
    const select = document.getElementById("supplyDeliverySelect");
    const deliveryId = select.value;
    const statusDiv = document.getElementById("status");

    if (!deliveryId) {
        statusDiv.textContent = "è«‹å…ˆé¸æ“‡ä¸€ç­†é…é€ç´€éŒ„";
        statusDiv.className = "status err";
        return;
    }

    try {
        // 1ï¸âƒ£ å–å¾—é…é€ç´€éŒ„
        const res = await fetch(`${baseUrl}/SupplyDelivery/${deliveryId}`);
        if (!res.ok) throw new Error("å–å¾— SupplyDelivery å¤±æ•—");
        const delivery = await res.json();

        // 2ï¸âƒ£ å–å¾—ç—…äººè³‡æ–™
        const patientId = localStorage.getItem("patientId");
        let deliverLocation = null;
        if (patientId) {
            const patientRes = await fetch(`${baseUrl}/Patient/${patientId}`);
            if (!patientRes.ok) throw new Error("å–å¾— Patient å¤±æ•—");
            const patient = await patientRes.json();

            // å‡è¨­ç¤¾å€å°å•†åº—å­˜åœ¨æ–¼ patient.contact.organization
            const contactOrgRef = patient.contact?.[0]?.organization?.reference; // ä¾‹å¦‚ "Organization/2326"
            if (contactOrgRef) {
                // é€™è£¡æˆ‘å€‘ç”¨ reference ç•¶ deliverTo
                deliverLocation = { reference: contactOrgRef, display: patient.contact[0].organization?.display || "ç¤¾å€å°å•†åº—" };
            }
        }

        // 3ï¸âƒ£ çµ„æˆ SupplyRequest
        const supplyRequest = {
            resourceType: "SupplyRequest",
            status: "active",
            intent: "order",
            category: [{
                coding: [{
                    system: "http://terminology.hl7.org/CodeSystem/supplyrequest-category",
                    code: "med",
                    display: "è—¥å“"
                }]
            }],
            itemCodeableConcept: delivery.suppliedItem.itemCodeableConcept,
            quantity: delivery.suppliedItem.quantity,
            occurrenceDateTime: new Date().toISOString()
        };

        // 4ï¸âƒ£ requester è¨˜éŒ„ç—…äºº
        if (patientId) {
            supplyRequest.requester = {
                reference: `Patient/${patientId}`,
                display: currentPatientEmail || "ç—…äºº"
            };
        }

        // 5ï¸âƒ£ deliverTo å¡«å…¥ç—…äººç¤¾å€å°å•†åº—
        if (deliverLocation) {
            supplyRequest.deliverTo = deliverLocation;
        }

        // 6ï¸âƒ£ é€å‡º SupplyRequest
        const createRes = await fetch(`${baseUrl}/SupplyRequest`, {
            method: "POST",
            headers: { "Content-Type": "application/fhir+json" },
            body: JSON.stringify(supplyRequest)
        });

        if (!createRes.ok) throw new Error("å»ºç«‹ SupplyRequest å¤±æ•—");
        const result = await createRes.json();
        console.log("âœ… SupplyRequest å·²å»ºç«‹:", result);

        statusDiv.textContent = "âœ… å·²æˆåŠŸç”³è«‹,è«‹ç­‰å€™å¿—å·¥æŠŠè—¥å“é€é”";
        statusDiv.className = "status ok";
    } catch (err) {
        console.error("âŒ ç”³è«‹å¤±æ•—", err);
        statusDiv.textContent = "âŒ ç”³è«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
        statusDiv.className = "status err";
    }
}

// é é¢è¼‰å…¥
document.addEventListener("DOMContentLoaded", async () => {
    await initPatientId();
});

function goToPatientPage() {
    window.location.href = "/patient.html"; 
}
</script>


</body>
</html>