<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ç¤¾å€ç®¡ç†å“¡å¾Œå°</title>
  <style>
  /* === åŸºæœ¬é…è‰² === */
:root {
  --primary: #6c63ff;
  --primary-dark: #5148db;
  --primary-light: #eef0ff;
  --bg: #f5f7ff;
  --text: #333;
  --border: #d0d4e6;
}

/* === æ•´é«”é¢¨æ ¼ === */
body {
  font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
  background: var(--bg);
  color: var(--text);
  margin: 0;
  padding: 20px;
}

/* === æ¨™é¡Œ === */
h2 {
  color: var(--primary);
  margin: 20px 0 10px 0;
  font-size: 24px;
}

hr {
  border: none;
  border-top: 1px solid var(--border);
  margin: 20px 0;
}

/* === çµ„ç¹”è³‡è¨Šå€å¡Š === */
.org-info {
  background: white;
  padding: 15px 20px;
  border-radius: 10px;
  margin: 15px 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-left: 4px solid var(--primary);
}

.org-info h3 {
  margin: 0 0 10px 0;
  color: var(--primary-dark);
  font-size: 18px;
}

.org-details {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 8px 15px;
  font-size: 14px;
}

.org-details strong {
  color: #555;
}

/* === è¡¨æ ¼å€å¡Šçš„å¡ç‰‡å¤–æ¡† === */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  margin-bottom: 30px;
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 10px rgba(0,0,0,0.06);
}

/* === è¡¨é ­ === */
th {
  padding: 14px 10px;
  background: var(--primary);
  color: white;
  font-size: 15px;
  letter-spacing: 0.5px;
}

/* === è¡¨æ ¼æ–‡å­— === */
td {
  padding: 12px 10px;
  border-bottom: 1px solid var(--border);
}

tbody tr:nth-child(even) { background-color: #f8f9ff; }
tbody tr:nth-child(odd) { background-color: #ffffff; }

tbody tr:hover {
  background-color: var(--primary-light);
  transition: 0.2s;
}

/* === æŒ‰éˆ• === */
button {
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 7px 14px;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
  transition: 0.25s;
  box-shadow: 0 2px 6px rgba(108, 99, 255, 0.3);
}

button:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
}

/* åœç”¨æŒ‰éˆ•çš„ç´…è‰²ç‰ˆæœ¬ï¼ˆä½ å¯é¸æ“‡æ˜¯å¦ä½¿ç”¨ï¼‰ */
button.disable-btn {
  background: #e74c3c;
  box-shadow: 0 2px 6px rgba(231, 76, 60, 0.3);
}
button.disable-btn:hover {
  background: #c0392b;
}

/* === Select === */
select {
  padding: 6px 10px;
  border: 1px solid var(--border);
  border-radius: 6px;
  outline: none;
  font-size: 14px;
}
select:hover {
  border-color: var(--primary);
}
select:focus {
  border-color: var(--primary-dark);
  box-shadow: 0 0 0 2px rgba(108,99,255,0.2);
}

/* === ç®¡ç†å“¡åç¨± === */
#adminName {
  font-weight: bold;
  color: var(--primary-dark);
}

/* === è¼‰å…¥ä¸­æ–‡å­—æ¨£ === */
#loading,
.table-loading {
  color: #666;
  font-size: 14px;
  padding: 10px;
}
  </style>
</head>
<body>

<h2>ğŸ‘¤ ç¤¾å€ç®¡ç†å“¡</h2>

<button id="logoutBtn" 
        style="float:right;background:#254bf3;margin-top:-35px;">
  ç™»å‡º
</button>
<p>ç›®å‰ç™»å…¥çš„ç®¡ç†å“¡ï¼š<span id="adminName">ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰</span></p>

<!-- æ–°å¢ï¼šçµ„ç¹”è³‡è¨Šå€å¡Š -->
<div id="orgInfo" class="org-info" style="display:none;">
  <h3>ğŸ¢ æ‰€å±¬çµ„ç¹”</h3>
  <div class="org-details">
    <strong>çµ„ç¹”åç¨±ï¼š</strong><span id="orgName">è¼‰å…¥ä¸­...</span>
    <strong>çµ„ç¹”åœ°å€ï¼š</strong><span id="orgAddress">è¼‰å…¥ä¸­...</span>
    <strong>çµ„ç¹”IDï¼š</strong><span id="orgId">è¼‰å…¥ä¸­...</span>
  </div>
</div>

<hr>

<h2>å¿—å·¥ç®¡ç†</h2>
<p>ç®¡ç†æ‚¨ç¤¾å€çš„å¿—å·¥å¸³è™Ÿèˆ‡å•Ÿç”¨ç‹€æ…‹</p>
<table>
  <thead>
    <tr>
      <th>å§“å</th>
      <th>Practitioner ID</th>
      <th>Role ID</th>
      <th>å¸³è™Ÿ(email)</th>
      <th>ç‹€æ…‹</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody id="volunteerTableBody">
    <tr><td colspan="6">è¼‰å…¥ä¸­...</td></tr>
  </tbody>
</table>

<h2>é…é€è«‹æ±‚æ¸…å–® </h2>
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>é¡åˆ¥</th>
      <th>ç‰©å“åç¨±</th>
      <th>æ•¸é‡</th>
      <th>ç‹€æ…‹</th>
      <th>ç”³è«‹è€…</th>
      <th>æ”¶ä»¶çµ„ç¹”</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody id="supplyRequestTableBody">
    <tr><td colspan="8">è¼‰å…¥ä¸­...</td></tr>
  </tbody>
</table>

<h2>é…é€ä»»å‹™æ¸…å–®</h2>
<table>
  <thead>
    <tr>
      <th>Task ID</th>
      <th>SupplyRequest</th>
      <th>ç‰©å“åç¨±</th>
      <th>æ•¸é‡</th>
      <th>æŒ‡æ´¾å¿—å·¥</th>
      <th>ç—…äººåœ°å€</th>
      <th>ä»»å‹™ç‹€æ…‹</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody id="taskTableBody">
    <tr><td colspan="7">è¼‰å…¥ä¸­...</td></tr>
  </tbody>
</table>

<script>
const FHIR_BASE = "http://203.64.84.204:8080/fhir";
let adminPractitionerId = null;
let currentOrgId = null;

// ------------------ A. å–å¾—ç®¡ç†å“¡è³‡è¨Š ------------------
async function loadAdminInfo() {
  const res = await fetch("/api/organizations", { credentials: "include" });
  const list = await res.json();
  if (!list || list.length === 0) { 
    alert("âš  ç„¡æ³•å–å¾—ç™»å…¥è³‡è¨Š"); 
    return; 
  }

  const admin = list[0];
  adminPractitionerId = admin.practitionerId;
  currentOrgId = admin.orgId;

  // é¡¯ç¤ºç®¡ç†å“¡å§“å
  const name = await getPersonName(adminPractitionerId);
  document.getElementById("adminName").innerText = `${name}ï¼ˆ${admin.roleDisplay || ""}ï¼‰`;

  // è¼‰å…¥çµ„ç¹”è³‡è¨Š
  await loadOrganizationInfo(currentOrgId);

  // è¼‰å…¥å…¶ä»–è³‡æ–™
  loadVolunteers();
  loadCommunitySupplyRequests();
  loadTasks();
}

// ------------------ æ–°å¢ï¼šè¼‰å…¥çµ„ç¹”è³‡è¨Š ------------------
async function loadOrganizationInfo(orgId) {
  try {
    const res = await fetch(`${FHIR_BASE}/Organization/${orgId}`);
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    
    const org = await res.json();
    const orgInfoDiv = document.getElementById("orgInfo");
    
    // é¡¯ç¤ºçµ„ç¹”åç¨±
    document.getElementById("orgName").textContent = org.name || "æœªå‘½å";
    
    // é¡¯ç¤ºçµ„ç¹”ID
    document.getElementById("orgId").textContent = orgId;
    
    // é¡¯ç¤ºçµ„ç¹”åœ°å€
    let addressText = "ç„¡åœ°å€è³‡è¨Š";
    if (org.address && org.address.length > 0) {
      const addr = org.address[0];
      
      // å„ªå…ˆä½¿ç”¨ text æ¬„ä½
      if (addr.text) {
        addressText = addr.text;
      } else {
        // çµ„åˆåœ°å€å„éƒ¨ä»½
        const parts = [];
        if (addr.line && addr.line.length > 0) {
          parts.push(addr.line.join(" "));
        }
        if (addr.city) parts.push(addr.city);
        if (addr.district) parts.push(addr.district);
        if (addr.state) parts.push(addr.state);
        if (addr.country) parts.push(addr.country);
        if (addr.postalCode) parts.push(addr.postalCode);
        
        addressText = parts.join(", ");
      }
    }
    
    document.getElementById("orgAddress").textContent = addressText;
    
    // é¡¯ç¤ºçµ„ç¹”è³‡è¨Šå€å¡Š
    orgInfoDiv.style.display = "block";
    
  } catch (error) {
    console.error("è¼‰å…¥çµ„ç¹”è³‡è¨Šå¤±æ•—:", error);
    document.getElementById("orgName").textContent = "è¼‰å…¥å¤±æ•—";
    document.getElementById("orgAddress").textContent = "ç„¡æ³•å–å¾—åœ°å€";
    document.getElementById("orgId").textContent = orgId;
    document.getElementById("orgInfo").style.display = "block";
  }
}

// ------------------ B. å–å¾— Person åç¨± ------------------
async function getPersonName(practitionerId) {
  try {
    const res = await fetch(`${FHIR_BASE}/Person?link=Practitioner/${practitionerId}`);
    if (!res.ok) return "æœªå‘½å";
    const bundle = await res.json();
    const person = bundle.entry?.[0]?.resource;
    return person?.name?.[0]?.text || "æœªå‘½å";
  } catch {
    return "éŒ¯èª¤";
  }
}

// ------------------ C. å¿—å·¥ç®¡ç† ------------------
async function loadVolunteers() {
  if (!currentOrgId) return;
  const tbody = document.getElementById("volunteerTableBody");
  tbody.innerHTML = `<tr><td colspan="6">è¼‰å…¥ä¸­...</td></tr>`;

  const url = `${FHIR_BASE}/PractitionerRole?organization=Organization/${currentOrgId}&_include=PractitionerRole:practitioner`;
  const res = await fetch(url);
  const bundle = await res.json();

  const practitioners = {};
  const roles = [];
  bundle.entry?.forEach(e => {
    if (e.resource.resourceType === "PractitionerRole") roles.push(e.resource);
    if (e.resource.resourceType === "Practitioner") practitioners[e.resource.id] = e.resource;
  });

  const volunteerRoles = roles.filter(r =>
    r.code?.some(c => c.coding?.some(cd => cd.code === "CommunityVolunteer"))
  );

  if (!volunteerRoles.length) {
    tbody.innerHTML = `<tr><td colspan="6">ç›®å‰æ²’æœ‰å¿—å·¥</td></tr>`;
    return;
  }

  const list = [];
  for (const role of volunteerRoles) {
    const pid = role.practitioner.reference.split("/")[1];
    const p = practitioners[pid];
    const name = await getPersonName(pid);
    list.push({
      name, practitionerId: pid, roleId: role.id,
      email: p?.identifier?.find(i=>i.system==="http://example.org/fhir/email")?.value || "â€”",
      active: role.active !== false
    });
  }

  tbody.innerHTML = "";
  list.forEach(v => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${v.name}</td>
      <td>${v.practitionerId}</td>
      <td>${v.roleId}</td>
      <td>${v.email}</td>
      <td>${v.active ? "å•Ÿç”¨" : "åœç”¨"}</td>
      <td>
        <button onclick="toggleVolunteer('${v.roleId}', ${v.active})">
          ${v.active ? "åœç”¨" : "å•Ÿç”¨"}
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function toggleVolunteer(roleId, isActive) {
  if (!confirm(`æ˜¯å¦è¦ ${isActive?"åœç”¨":"å•Ÿç”¨"} é€™ä½å¿—å·¥ï¼Ÿ`)) return;
  const res = await fetch(`${FHIR_BASE}/PractitionerRole/${roleId}`);
  const role = await res.json();
  role.active = !isActive;
  await fetch(`${FHIR_BASE}/PractitionerRole/${roleId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/fhir+json" },
    body: JSON.stringify(role)
  });
  loadVolunteers();
}


// ------------------ D. SupplyRequest ------------------
async function loadCommunitySupplyRequests() {
  if (!currentOrgId) return;
  const tbody = document.getElementById("supplyRequestTableBody");
  tbody.innerHTML = `<tr><td colspan="8">è¼‰å…¥ä¸­...</td></tr>`;

  const patientId = localStorage.getItem("patientId");
  let url = `${FHIR_BASE}/SupplyRequest?_count=200`;
  if (patientId) url += `&requester=Patient/${patientId}`;

  const res = await fetch(url);
  const bundle = await res.json();
  const list = bundle.entry?.map(e => e.resource)
    .filter(sr => sr.deliverTo?.reference === `Organization/${currentOrgId}`)
    .sort((a, b) => (b.id || '').localeCompare(a.id || ''))
    || [];
  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="8">æ²’æœ‰é…é€è«‹æ±‚æ¸…å–®</td></tr>`;
    return;
  }
  tbody.innerHTML = "";

  for (const sr of list) {
    let requesterText = "-";
    if (sr.requester?.reference) {
      try {
        const patientRes = await fetch(`${FHIR_BASE}/${sr.requester.reference}`);
        const patient = await patientRes.json();
        const name = patient.name?.[0]?.text || "-";
        const email = patient.telecom?.find(t => t.system === "email")?.value || "-";
        requesterText = `${name} (${email})`;
      } catch {
        requesterText = sr.requester.reference;
      }
    }

    const tr = document.createElement("tr");
  tr.innerHTML = `
  <td>${sr.id}</td>
  <td>${sr.category?.coding?.[0]?.display || "-"}</td>
  <td>${sr.itemCodeableConcept?.text || "-"}</td>
  <td>${sr.quantity?.value || "-"} ${sr.quantity?.unit || ""}</td>
  <td>${sr.status || "-"}</td>
  <td>${requesterText}</td>
  <td>${sr.deliverTo?.display || "-"}</td>
  <td><button onclick="createTaskFromSupplyRequest('${sr.id}')">å»ºç«‹ä»»å‹™</button></td>
`;

    tbody.appendChild(tr);
  }
}
document.getElementById("logoutBtn").onclick = async () => {
  await fetch("/api/logout", {
    method: "POST",
    credentials: "include"
  });

  localStorage.clear();  // å¦‚æœä½ æœ‰å„²å­˜ email / orgId
  window.location.href = "/login.html"; // å›é¦–é æˆ–ç™»å…¥é 
};


// ------------------ E. Task ------------------
function parseTaskMedication(task) {
  let medName="-", medQty="-";
  task.input?.forEach(input=>{
    const code = input.type?.coding?.[0]?.code;
    if(code==="medication") medName = input.valueCodeableConcept?.text||input.valueCodeableConcept?.coding?.[0]?.display||"-";
    if(code==="medication-quantity") medQty = input.valueQuantity?.value||"-";
  });
  return {medName, medQty};
}
async function getPatientAddressByReference(patientRef) {
  if (!patientRef) return "-";

  try {
    const res = await fetch(`${FHIR_BASE}/${patientRef}`);
    const patient = await res.json();

    const addr = patient.address?.[0];
    if (!addr) return "-";

    return (
      addr.text ||
      `${addr.country || ""}${addr.state || ""}${addr.city || ""}${addr.district || ""}${addr.line?.join("") || ""}`
    );
  } catch {
    return "-";
  }
}


async function loadTasks() {
  if(!adminPractitionerId) return;
  const tbody = document.getElementById("taskTableBody");
  tbody.innerHTML = `<tr><td colspan="7">è¼‰å…¥ä¸­...</td></tr>`;

  // å–å¾— Task
  const res = await fetch(`${FHIR_BASE}/Task?requester=Practitioner/${adminPractitionerId}&_count=100`);
  const bundle = await res.json();
  if(!bundle.entry || !bundle.entry.length){
    tbody.innerHTML=`<tr><td colspan="7">æ²’æœ‰ä»»å‹™</td></tr>`;
    return;
  }

  // å–å¾—å¿—å·¥åˆ—è¡¨ (PracitionerRole)
  const couriers = [];
  const roleRes = await fetch(`${FHIR_BASE}/PractitionerRole?organization=Organization/${currentOrgId}&_count=200`);
  const roleBundle = await roleRes.json();

  for (const e of roleBundle.entry || []) {
    const role = e.resource;
    if(role.code?.some(c => c.coding?.some(cd => cd.code === "CommunityVolunteer"))) {
      const pid = role.practitioner.reference.split("/")[1];
      let name = pid; // fallback

      try {
        const personRes = await fetch(`${FHIR_BASE}/Person?link=Practitioner/${pid}`);
        const personBundle = await personRes.json();
        const person = personBundle.entry?.[0]?.resource;
        if(person?.name?.length) {
          const n = person.name[0];
          name = n.text || ((n.given?.join(" ") || "") + (n.family ? " " + n.family : ""));
        }
      } catch {
        // ä¿ç•™ pid
      }

      couriers.push({ id: pid, name });
    }
  }

  tbody.innerHTML = "";

  for (const e of bundle.entry) {
    const task = e.resource;
    const {medName, medQty} = parseTaskMedication(task);

    // â¤ å–å¾— SupplyRequest çš„ ID
    const srRef = task.focus?.reference; // SupplyRequest/xxxx
    let patientEmail = "-";
    let patientAddress = "-";

    if (srRef) {
  try {
    const supplyReqRes = await fetch(`${FHIR_BASE}/${srRef}`);
    const supplyReq = await supplyReqRes.json();

    // ğŸ‘ SupplyRequest.requester å°±æ˜¯ Patient/xxx
    const patientRef = supplyReq.requester?.reference;

    patientAddress = await getPatientAddressByReference(patientRef);
  } catch {
    patientAddress = "-";
  }
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${task.id}</td>
      <td>${srRef || "-"}</td>
      <td>${medName}</td>
      <td>${medQty}</td>

      <td>
        <select id="volunteer-${task.id}">
          ${couriers.map(c => `<option value="${c.id}">${c.name} (${c.id})</option>`).join("")}
        </select>
      </td>

      <td>${patientAddress}</td>

      <td>${task.status || "-"}</td>

      <td>
        <button onclick="assignVolunteerToTask('${task.id}', document.getElementById('volunteer-${task.id}').value)">
          æŒ‡æ´¾
        </button>
      </td>
    `;

    tbody.appendChild(tr);
  }
}


async function assignVolunteerToTask(taskId, practitionerId){
  const taskRes = await fetch(`${FHIR_BASE}/Task/${taskId}`);
  const task = await taskRes.json();
  const hasOwner = !!task.owner;
  const ops = [{ op: hasOwner?"replace":"add", path:"/owner", value:{reference:`Practitioner/${practitionerId}`}}];
  const res = await fetch(`${FHIR_BASE}/Task/${taskId}`, {
    method:"PATCH", headers:{"Content-Type":"application/json-patch+json"}, body:JSON.stringify(ops)
  });
  if(!res.ok){ alert("æŒ‡æ´¾å¤±æ•—"); return; }
  alert("âœ” å·²æŒ‡æ´¾å¿—å·¥");
  loadTasks();
}

function viewTaskDetails(taskId){
  window.open(`${FHIR_BASE}/Task/${taskId}`,"_blank");
}

async function createTaskFromSupplyRequest(supplyRequestId){
  const supplyRes = await fetch(`${FHIR_BASE}/SupplyRequest/${supplyRequestId}`);
  const supply = await supplyRes.json();

  const taskResource = {
    resourceType:"Task",
    status:"accepted",
    intent:"order",
    code:{ coding:[{ system:"http://example.org/task-code", code:"deliver-item", display:"é…é€ç‰©å“" }] },
    focus:{ reference:`SupplyRequest/${supplyRequestId}` },
    requester:{ reference:`Practitioner/${adminPractitionerId}` },
    authoredOn:new Date().toISOString(),
    executionPeriod:{ start:new Date().toISOString(), end:new Date(Date.now()+24*3600*1000).toISOString() },
    note:[{text:"è«‹ä¾ç…§éœ€æ±‚é…é€"}],
    input:[]
  };

  if(supply.itemCodeableConcept) taskResource.input.push({type:{coding:[{system:"http://hl7.org/fhir/task-input-type", code:"medication", display:"Item"}]}, valueCodeableConcept:supply.itemCodeableConcept});
  if(supply.quantity) taskResource.input.push({type:{coding:[{system:"http://hl7.org/fhir/task-input-type", code:"medication-quantity", display:"Quantity"}]}, valueQuantity:supply.quantity});

  const res = await fetch(`${FHIR_BASE}/Task`, {method:"POST", headers:{"Content-Type":"application/fhir+json"}, body:JSON.stringify(taskResource)});
  if(!res.ok){ alert("å»ºç«‹ Task å¤±æ•—"); return; }
  alert(`âœ” ä»»å‹™å·²å»ºç«‹ (SupplyRequest/${supplyRequestId})`);
  loadTasks();
}

// ------------------ F. å•Ÿå‹• ------------------
window.onload = loadAdminInfo;
</script>

</body>
</html>