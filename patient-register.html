<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é¸æ“‡ç‰©æµçµ„ç¹”</title>
  <style>
/* ===== Reset ===== */
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; font-family: 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; }

/* ===== Container & Card ===== */
.container {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  min-height: 100%;
  padding: 1rem;
}
.card {
  width: 100%;
  max-width: 480px;
  padding: 2.5rem;
  border-radius: 20px;
  background: rgba(255,255,255,0.1);
  backdrop-filter: blur(12px);
  box-shadow: 0 12px 32px rgba(0,0,0,0.25);
  transition: transform 0.3s, box-shadow 0.3s;
}
.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 18px 36px rgba(0,0,0,0.3);
}
.card h1 {
  text-align: center;
  margin-bottom: 2rem;
  font-weight: 700;
  font-size: 1.8rem;
  letter-spacing: 0.5px;
}

/* ===== Labels & Inputs ===== */
label { margin-top: 1rem; display: block; font-weight: 500; }
input, select {
  width: 100%;
  padding: 0.85rem 1rem;
  margin-top: 0.3rem;
  border-radius: 12px;
  border: none;
  background: rgba(255,255,255,0.15);
  color: #fff;
  font-size: 1rem;
  transition: background 0.3s, box-shadow 0.3s;
}
input:focus, select:focus {
  outline: none;
  background: rgba(255,255,255,0.25);
  box-shadow: 0 0 8px rgba(255,255,255,0.5);
}
select option { background: #667eea; color: #fff; }

/* ===== Placeholder ===== */
input::placeholder { color: rgba(255,255,255,0.7); }

/* ===== Buttons ===== */
button {
  width: 100%;
  padding: 0.85rem;
  border: none;
  border-radius: 12px;
  background: #ff8a65;
  margin-top: 1rem;
  cursor: pointer;
  color: #fff;
  font-size: 1rem;
  font-weight: 600;
  letter-spacing: 0.5px;
  transition: background 0.3s, transform 0.2s;
  position: relative;
  min-height: 50px;
  overflow: hidden;
}
button:hover:not(:disabled) {
  background: #ff7043;
  transform: translateY(-2px);
}
button:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none !important;
}

/* ===== Loading Button Animation ===== */
button.loading {
  background: #ff8a65 !important;
  color: transparent;
}
button.loading::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: button-spin 0.8s linear infinite;
}
@keyframes button-spin {
  to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* ===== Logout Button ===== */
#logoutBtn {
  position: absolute;
  top: 1rem;
  right: 1rem;
  width: auto;
  padding: 0.5rem 1rem;
  background: #ff5c5c;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
#logoutBtn:hover:not(:disabled) { background: #ff3b3b; }

/* ===== Message Boxes ===== */
#message, .application-status {
  margin-top: 1rem;
  padding: 0.85rem;
  border-radius: 12px;
  text-align: center;
  display: none;
  font-weight: 500;
}
#message { background: rgba(220,53,69,0.6); }
#message.success { background: rgba(40,167,69,0.6); }
.application-status { background: rgba(255,193,7,0.6); color: #856404; }

/* ===== Hidden ===== */
.hidden { display: none !important; }

/* ===== Sections ===== */
#applyOrgDiv, #createRoleDiv {
  margin-top: 2rem;
  padding: 1.5rem;
  background: rgba(255,255,255,0.1);
  border-radius: 16px;
  backdrop-filter: blur(10px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}
#applyOrgDiv h2, #createRoleDiv h2 { text-align: center; margin-bottom: 1rem; font-weight: 600; }

/* ===== Small Buttons ===== */
#cancelBtn, #cancelCreateRoleBtn {
  background: rgba(170,170,170,0.6);
  margin-top: 0.5rem;
}
#cancelBtn:hover:not(:disabled), #cancelCreateRoleBtn:hover:not(:disabled) { background: rgba(170,170,170,0.8); }

/* ===== Inline Buttons ===== */
#showApplyBtn, #showCreateRoleBtn, #goPatientBtn {
  background: rgba(255,255,255,0.2);
  color: #fff;
  font-weight: 600;
}
#showApplyBtn:hover:not(:disabled), #showCreateRoleBtn:hover:not(:disabled), #goPatientBtn:hover:not(:disabled) { background: rgba(255,255,255,0.35); }

/* ===== Loading Overlay ===== */
#loadingOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  display: none;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(255,255,255,0.3);
  border-top: 4px solid #ff8a65;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-text {
  color: white;
  font-size: 1.2rem;
  margin-top: 10px;
  text-align: center;
  max-width: 300px;
}

/* ===== Progress Bar ===== */
.progress-container {
  width: 300px;
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
  overflow: hidden;
  margin-top: 15px;
}

.progress-bar {
  height: 6px;
  background: linear-gradient(90deg, #ff8a65, #ff7043);
  width: 0%;
  transition: width 0.5s ease;
  border-radius: 10px;
}
  </style>
</head>
<body>

<!-- å…¨åŸŸè¼‰å…¥é®ç½© -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">æ­£åœ¨æŠŠç™»å…¥è³‡è¨Šå¯«é€²ä¼ºæœå™¨ä¸­...è«‹ç¨å€™</div>
  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>
</div>

<button id="logoutBtn">ğŸšª ç™»å‡º</button>

<div class="container">
  <div class="card">
    <h1>é¸æ“‡èº«ä»½</h1>

    <label for="orgSelect">æ‚¨çš„èº«ä»½ï¼š</label>
    <select id="orgSelect"></select>

    <button id="btnCheck">ç¢ºèª</button>
    <button id="showApplyBtn">ç”³è«‹æ©Ÿæ§‹çµ„ç¹”</button>

    <div id="applyOrgDiv" class="hidden">
      <h2>ç”³è«‹æ©Ÿæ§‹çµ„ç¹”</h2>
      <label>çµ„ç¹”é¡å‹ï¼š</label>
      <select id="orgType">
        <option value="logistics">ç‰©æµå…¬å¸</option>
        <option value="retail">ç¤¾å€å°å•†åº—</option>
      </select>

      <label>çµ±ä¸€ç·¨è™Ÿï¼š</label>
      <input id="taxId" type="text" placeholder="è¼¸å…¥8ä½æ•¸çµ±ç·¨" pattern="\d{8}">

      <label>æ©Ÿæ§‹åç¨±ï¼š</label>
      <input id="orgName" type="text" placeholder="è¼¸å…¥åç¨±">

      <label>æ©Ÿæ§‹åœ°å€ï¼š</label>
      <input id="orgAddress" type="text" placeholder="è¼¸å…¥åœ°å€">

      <label>è·ä½ï¼š</label>
      <select id="position">
      <option value="LogisticsRootAdmin">ç‰©æµè² è²¬äºº</option>
      <option value="CommunityAdmin">ç¤¾å€ç®¡ç†å“¡</option>
      </select>

      <button id="applyBtn">é€å‡ºç”³è«‹</button>
      <button id="cancelBtn">å–æ¶ˆ</button>
    </div>

    <div id="createRoleDiv" class="hidden">
      <h2>ç”³è«‹è·ä½</h2>
      <label>é¸æ“‡çµ„ç¹”ï¼š</label>
      <select id="roleOrgSelect"></select>

      <label>é¸æ“‡è·ä½ï¼š</label>
      <select id="roleSelect"></select>

      <button id="createRoleBtn">é€å‡ºç”³è«‹</button>
      <button id="cancelCreateRoleBtn">å–æ¶ˆ</button>
    </div>

    <button id="showCreateRoleBtn">ç”³è«‹è·ä½</button>
    <button id="goPatientBtn">é€²å…¥æ°‘çœ¾é é¢</button>

    <div id="message"></div>
    <div id="applicationStatus" class="hidden"></div>
  </div>
</div>

<script>
// å…¨åŸŸè®Šæ•¸
let userEmail = "";
let userOrganizations = [];
let isProcessing = false; // é˜²æ­¢é‡è¤‡æäº¤

// ğŸ”§ è¦è¢«çµ±ä¸€ç®¡ç†é¡¯ç¤º/éš±è—çš„æŒ‰éˆ•
const allButtons = [
  "btnCheck",
  "showApplyBtn",
  "showCreateRoleBtn",
  "goPatientBtn"
];

// ğŸ”§ æ‰€æœ‰å¤§å€å¡Š
const allSections = [
  "applyOrgDiv",
  "createRoleDiv",
  "patientDiv"
];

// ============================================
// ğŸ”§ è¼‰å…¥ç‹€æ…‹ç®¡ç†å·¥å…·å‡½å¼
// ============================================

// é¡¯ç¤ºå…¨åŸŸè¼‰å…¥å‹•ç•«
function showGlobalLoading(message = "æ­£åœ¨æŠŠç™»å…¥è³‡è¨Šå¯«é€²ä¼ºæœå™¨ä¸­...è«‹ç¨å€™") {
  const overlay = document.getElementById("loadingOverlay");
  const text = document.getElementById("loadingText");
  const progressBar = document.getElementById("progressBar");
  
  text.textContent = message;
  progressBar.style.width = "0%";
  overlay.style.display = "flex";
  
  // æ¨¡æ“¬é€²åº¦æ¢å‹•ç•«
  setTimeout(() => {
    progressBar.style.width = "30%";
  }, 300);
  setTimeout(() => {
    progressBar.style.width = "60%";
  }, 600);
  setTimeout(() => {
    progressBar.style.width = "90%";
  }, 1200);
  
  // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
  document.querySelectorAll("button").forEach(btn => {
    if (!btn.id.includes("cancel")) { // ä¿æŒå–æ¶ˆæŒ‰éˆ•å¯ç”¨
      btn.disabled = true;
    }
  });
}

// éš±è—å…¨åŸŸè¼‰å…¥å‹•ç•«
function hideGlobalLoading() {
  const overlay = document.getElementById("loadingOverlay");
  const progressBar = document.getElementById("progressBar");
  
  // å®Œæˆé€²åº¦æ¢
  progressBar.style.width = "100%";
  
  setTimeout(() => {
    overlay.style.display = "none";
    
    // å•Ÿç”¨æ‰€æœ‰æŒ‰éˆ•
    document.querySelectorAll("button").forEach(btn => {
      btn.disabled = false;
    });
  }, 500);
}

// æŒ‰éˆ•è¼‰å…¥ç‹€æ…‹
function setButtonLoading(buttonId, isLoading) {
  const button = document.getElementById(buttonId);
  if (!button) return;
  
  if (isLoading) {
    button.classList.add("loading");
    button.disabled = true;
    button.innerHTML = ""; // æ¸…ç©ºæ–‡å­—ï¼Œç”¨CSSå‹•ç•«æ›¿ä»£
  } else {
    button.classList.remove("loading");
    button.disabled = false;
    
    // æ¢å¾©æŒ‰éˆ•æ–‡å­—
    switch(buttonId) {
      case "applyBtn":
        button.textContent = "é€å‡ºç”³è«‹";
        break;
      case "createRoleBtn":
        button.textContent = "é€å‡ºç”³è«‹";
        break;
      case "btnCheck":
        button.textContent = "ç¢ºèª";
        break;
    }
  }
}

// é˜²æ­¢é‡è¤‡æäº¤
function preventDoubleSubmit(action, callback) {
  if (isProcessing) {
    showMessage("è«‹ç­‰å¾…ä¸Šä¸€å€‹æ“ä½œå®Œæˆ", false);
    return;
  }
  
  isProcessing = true;
  
  // åŸ·è¡Œå›èª¿å‡½æ•¸
  const result = callback();
  
  // å¦‚æœå›å‚³çš„æ˜¯ Promiseï¼Œè™•ç†å®Œæˆå¾Œé‡ç½®ç‹€æ…‹
  if (result && typeof result.then === "function") {
    return result.finally(() => {
      isProcessing = false;
    });
  } else {
    isProcessing = false;
    return result;
  }
}

// ============================================
// ğŸ”§ å·¥å…·å‡½å¼
// ============================================

// â­ å·¥å…·ï¼šéš±è—æ‰€æœ‰æŒ‰éˆ•
function hideAllButtons() {
  allButtons.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.add("hidden");
  });
}

// â­ å·¥å…·ï¼šé¡¯ç¤ºæ‰€æœ‰æŒ‰éˆ•
function showAllButtons() {
  allButtons.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.remove("hidden");
  });
}

// â­ å·¥å…·ï¼šéš±è—æ‰€æœ‰å€å¡Š
function hideAllSections() {
  allSections.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.add("hidden");
  });
}

// ============================================
// 1ï¸âƒ£ ç”³è«‹æ©Ÿæ§‹çµ„ç¹”
// ============================================

document.getElementById("showApplyBtn").onclick = () => {
  hideAllButtons();
  hideAllSections();
  document.getElementById("applyOrgDiv").classList.remove("hidden");
};

// å–æ¶ˆç”³è«‹
document.getElementById("cancelBtn").onclick = () => {
  hideAllSections();
  showAllButtons();
  clearApplyForm();
};

// ============================================
// 2ï¸âƒ£ å»ºç«‹è·ä½
// ============================================

document.getElementById("showCreateRoleBtn").onclick = () => {
  hideAllButtons();
  hideAllSections();
  document.getElementById("createRoleDiv").classList.remove("hidden");
  loadActiveOrgs();
};

// å–æ¶ˆå»ºç«‹è·ä½
document.getElementById("cancelCreateRoleBtn").onclick = () => {
  hideAllSections();
  showAllButtons();
};

// ============================================
// 3ï¸âƒ£ æ°‘çœ¾é é¢
// ============================================

document.getElementById("goPatientBtn").onclick = () => {
  showGlobalLoading("æ­£åœ¨å°å‘æ°‘çœ¾é é¢...");
  setTimeout(() => {
    window.location.href = "/patient.html";
  }, 1000);
};

// ============================================
// 4ï¸âƒ£ ç™»å‡ºåŠŸèƒ½
// ============================================

document.getElementById("logoutBtn").onclick = async () => {
  showGlobalLoading("æ­£åœ¨ç™»å‡º...");
  
  try {
    const res = await fetch("/api/logout", {
      method: "POST",
      credentials: "include"
    });

    localStorage.removeItem("email");
    localStorage.removeItem("MAIN_ORG_ID");

    setTimeout(() => {
      if (res.ok) {
        alert("å·²æˆåŠŸç™»å‡ºï¼");
        window.location.href = "/login.html";
      } else {
        alert("ç™»å‡ºæ™‚ç™¼ç”Ÿå•é¡Œï¼Œä½†å·²æ¸…é™¤ç™»å…¥è³‡è¨Š");
        window.location.href = "/login.html";
      }
    }, 500);
    
  } catch (err) {
    setTimeout(() => {
      alert("ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼Œä½†å·²æ¸…é™¤ç™»å…¥è³‡è¨Š");
      localStorage.removeItem("email");
      localStorage.removeItem("MAIN_ORG_ID");
      window.location.href = "/login.html";
    }, 500);
  }
};

// ============================================
// 5ï¸âƒ£ è¼‰å…¥ active çµ„ç¹”æ¸…å–®
// ============================================

async function loadActiveOrgs() {
  try {
    const res = await fetch("/api/active-orgs");
    if (!res.ok) throw new Error("å–å¾— active çµ„ç¹”å¤±æ•—");

    const data = await res.json();
    const list = data.organizations || [];

    const select = document.getElementById("roleOrgSelect");
    select.innerHTML = "";

    const defaultOpt = document.createElement("option");
    defaultOpt.value = "";
    defaultOpt.textContent = "--è«‹é¸æ“‡çµ„ç¹”--";
    select.appendChild(defaultOpt);

    list.forEach(org => {
      const opt = document.createElement("option");
      opt.value = org.id;
      opt.textContent = org.name;
      opt.dataset.type = org.type?.[0]?.coding?.[0]?.display || org.type?.[0]?.text || "";
      select.appendChild(opt);
    });

    console.log("ğŸ“¦ Active organizations loaded:", list);
  } catch (err) {
    console.error("âŒ ç„¡æ³•è¼‰å…¥ active çµ„ç¹”:", err);
    showMessage("ç„¡æ³•è¼‰å…¥çµ„ç¹”åˆ—è¡¨", false);
  }
}

// ============================================
// 6ï¸âƒ£ è·ä½å°æ‡‰èˆ‡ç”³è«‹
// ============================================

const roleCodeMap = {
  "ç‰©æµç®¡ç†å“¡": "LogisticsAdmin",
  "ç‰©æµé…é€å“¡": "LogisticsCourier",
  "ç¤¾å€å¿—å·¥": "CommunityVolunteer"
};

// é¸æ“‡çµ„ç¹” â†’ é¡¯ç¤ºå°æ‡‰è·ä½
document.getElementById("roleOrgSelect").addEventListener("change", function () {
  const selectedOption = this.options[this.selectedIndex];
  const typeDisplay = selectedOption.dataset.type;
  const roleSelect = document.getElementById("roleSelect");

  roleSelect.innerHTML = "";

  if (typeDisplay === "Logistics Company") {
    addRoleOption(roleSelect, "ç‰©æµç®¡ç†å“¡");
    addRoleOption(roleSelect, "ç‰©æµé…é€å“¡");
  } else if (typeDisplay === "Community Store") {
    addRoleOption(roleSelect, "ç¤¾å€å¿—å·¥");
  } else {
    addRoleOption(roleSelect, "(æ­¤çµ„ç¹”æš«ç„¡å¯å»ºç«‹ä¹‹è·ä½)");
  }
});

// å»ºç«‹è·ä½ç”³è«‹
document.getElementById("createRoleBtn").onclick = async () => {
  preventDoubleSubmit("createRole", async () => {
    const organizationId = document.getElementById("roleOrgSelect").value;
    const roleName = document.getElementById("roleSelect").value;

    if (!organizationId || !roleName) {
      showMessage("è«‹é¸æ“‡çµ„ç¹”èˆ‡è·ä½", false);
      return;
    }

    const roleCode = roleCodeMap[roleName];
    if (!roleCode) {
      showMessage("æ­¤è·ä½æ²’æœ‰å°æ‡‰çš„ FHIR è§’è‰²ä»£ç¢¼", false);
      return;
    }

    const email = localStorage.getItem("email");
    if (!email) {
      showMessage("æ‰¾ä¸åˆ° emailï¼Œè«‹é‡æ–°ç™»å…¥", false);
      return;
    }

    // æª¢æŸ¥æ˜¯å¦å·²åŠ å…¥è©²çµ„ç¹”
    if (window.userOrganizations) {
      const exists = userOrganizations.some(org => org.orgId === organizationId);
      if (exists) {
        showMessage("âŒ ä½ å·²ç¶“åŠ å…¥æˆ–ç”³è«‹éæ­¤çµ„ç¹”ï¼Œä¸èƒ½ç”³è«‹åŒçµ„ç¹”çš„å…¶ä»–è·ä½ã€‚", false);
        return;
      }
    }

    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    setButtonLoading("createRoleBtn", true);
    showGlobalLoading("æ­£åœ¨ç”³è«‹è·ä½...è³‡æ–™å¯«å…¥ä¸­");

    try {
      const payload = {
        email,
        orgId: organizationId,
        roleCode,
        roleName
      };

      console.log("ğŸ”µ é€å‡ºåˆ°å¾Œç«¯ apply-existing-org:", payload);

      const res = await fetch("/api/apply-existing-org", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (res.ok) {
        showMessage("âœ… è·ä½ç”³è«‹æˆåŠŸï¼è«‹ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸", true);
        hideAllSections();
        showAllButtons();
        
        // é‡æ–°è¼‰å…¥çµ„ç¹”æ¸…å–®
        setTimeout(() => {
          loadOrganizations();
        }, 1000);
      } 
    } catch (error) {
      
    } finally {
      setButtonLoading("createRoleBtn", false);
      hideGlobalLoading();
    }
  });
};

// ============================================
// 7ï¸âƒ£ è¼‰å…¥å·²ç¶å®šçš„çµ„ç¹”
// ============================================

async function loadOrganizations() {
  const orgSelect = document.getElementById("orgSelect");
  
  // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  setButtonLoading("btnCheck", true);
  orgSelect.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';

  try {
    const res = await fetch("/api/organizations", { credentials: "include" });
    if (!res.ok) throw new Error(`ç„¡æ³•è¼‰å…¥çµ„ç¹”: ${res.status}`);

    const list = await res.json();
    userOrganizations = list;

    orgSelect.innerHTML = "";

    if (list.length === 0) {
      const option = document.createElement("option");
      option.value = "";
      option.textContent = "å°šæœªåŠ å…¥ä»»ä½•çµ„ç¹”";
      orgSelect.appendChild(option);
      return;
    }

    // è¼‰å…¥æ‰€æœ‰çµ„ç¹”é¸é …
    list.forEach(org => {
      const option = document.createElement("option");
      option.value = org.orgId;
      option.textContent = `${org.orgName}ï¼ˆ${org.roleDisplay || "æœªè¨­å®šè·ä½"}ï¼‰`;
      orgSelect.appendChild(option);
    });
  } catch (err) {
    console.error("âŒ è¼‰å…¥çµ„ç¹”å¤±æ•—:", err);
    showMessage("ç„¡æ³•è¼‰å…¥çµ„ç¹”è³‡æ–™", false);
    
    // é¡¯ç¤ºéŒ¯èª¤é¸é …
    const option = document.createElement("option");
    option.value = "";
    option.textContent = "è¼‰å…¥å¤±æ•—";
    orgSelect.innerHTML = "";
    orgSelect.appendChild(option);
  } finally {
    setButtonLoading("btnCheck", false);
  }
}

// ============================================
// 8ï¸âƒ£ ç¢ºèªèº«ä»½ä¸¦è·³è½‰
// ============================================

document.getElementById("btnCheck").onclick = async () => {
  preventDoubleSubmit("checkRole", async () => {
    const orgId = document.getElementById("orgSelect").value;

    if (!orgId) {
      showMessage("è«‹é¸æ“‡ä¸€å€‹çµ„ç¹”æˆ–å…ˆç”³è«‹åŠ å…¥", false);
      return;
    }

    const selected = userOrganizations.find(o => o.orgId === orgId);
    if (!selected) {
      showMessage("æ‰¾ä¸åˆ°çµ„ç¹”è³‡æ–™", false);
      return;
    }

    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    setButtonLoading("btnCheck", true);
    showGlobalLoading("æ­£åœ¨ç¢ºèªæ‚¨çš„èº«ä»½...");

    try {
      const ok = await checkUserRole(orgId);
      if (!ok) return;

      const res = await fetch("/api/select-organization", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({
          organizationId: orgId,
          practitionerRoleId: selected.roleId
        })
      });

      const body = await res.json();
      if (!res.ok) {
        showMessage(body.error || "è§’è‰²ç¢ºèªå¤±æ•—", false);
        return;
      }

      const roleCode = body.role;

      // å„²å­˜ç›®å‰é¸çš„çµ„ç¹”
      localStorage.setItem("MAIN_ORG_ID", orgId);

      // é€šçŸ¥å¾Œç«¯é¸æ“‡çš„çµ„ç¹”
      await fetch("/api/organizations/select", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ orgId })
      });

      // é¡¯ç¤ºè·³è½‰è¨Šæ¯
      showGlobalLoading(`æ­£åœ¨å°å‘ ${selected.roleDisplay || roleCode} é é¢...`);

      // è§’è‰²è·³è½‰
      setTimeout(() => {
        switch (roleCode) {
          case "LogisticsRootAdmin":  window.location.href="/logisticsRootAdmin.html"; break;
          case "LogisticsAdmin":      window.location.href="/logisticsadmin.html";     break;
          case "LogisticsCourier":    window.location.href="/logisticsTask.html";      break;
          case "CommunityAdmin":      window.location.href="/communityadmin.html";     break;
          case "CommunityVolunteer":  window.location.href="/communityTask.html";      break;
          default:
            showMessage("æœªçŸ¥è§’è‰²ï¼š" + roleCode, false);
        }
      }, 1000);

    } catch (error) {
      console.error("âŒ ç¢ºèªèº«ä»½å¤±æ•—:", error);
      showMessage("ç¢ºèªèº«ä»½å¤±æ•—ï¼š" + error.message, false);
    } finally {
      setButtonLoading("btnCheck", false);
    }
  });
};

// ============================================
// 9ï¸âƒ£ æª¢æŸ¥ä½¿ç”¨è€…è§’è‰²ç‹€æ…‹
// ============================================

async function checkUserRole(orgId) {
  if (!orgId) return false;

  try {
    const res = await fetch(`/api/organization/check-role?orgId=${orgId}`, { 
      credentials: "include" 
    });

    if (!res.ok) throw new Error("æª¢æŸ¥çµ„ç¹”è§’è‰²å¤±æ•—");
    
    const data = await res.json();
    console.log("è§’è‰²æª¢æŸ¥çµæœ:", data);

    if (data.hasRole) {
      if (data.active) {
        showMessage(`æ‚¨å·²æ˜¯ã€Œ${data.organizationName}ã€çš„ã€Œ${data.position}ã€`, true);
        return true;
      } 
      showMessage("æ‚¨çš„ç”³è«‹æ­£åœ¨å¯©æ ¸ä¸­ï¼Œè«‹è€å¿ƒç­‰å¾…", false);
      return false;
    }

    showMessage("å°šæœªåŠ å…¥ä»»ä½•çµ„ç¹”è·ä½", false);
    return false;

  } catch (err) {
    console.error("âŒ æª¢æŸ¥è§’è‰²å¤±æ•—:", err);
    showMessage("æª¢æŸ¥çµ„ç¹”è§’è‰²å¤±æ•—", false);
    return false;
  }
}

// ============================================
// ğŸ”Ÿ å–å¾—ç™»å…¥è€… Email
// ============================================

async function loadPersonEmail() {
  try {
    showGlobalLoading("æ­£åœ¨å–å¾—ä½¿ç”¨è€…è³‡è¨Š...");
    const res = await fetch("/api/person", { credentials: "include" });
    if (!res.ok) throw new Error("ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Š");
    
    const data = await res.json();
    userEmail = data.email;
    localStorage.setItem("email", userEmail);
    console.log("âœ… ä½¿ç”¨è€… Email:", userEmail);
    
    hideGlobalLoading();
  } catch (err) {
    console.error("âŒ å–å¾—ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—:", err);
    showMessage("ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Š", false);
    hideGlobalLoading();
  }
}

// ============================================
// 1ï¸âƒ£1ï¸âƒ£ çµ±ç·¨æª¢æŸ¥
// ============================================

document.getElementById("taxId").addEventListener("blur", async () => {
  const taxId = document.getElementById("taxId").value.trim();
  
  if (!taxId) return;
  
  // çµ±ç·¨æ ¼å¼æª¢æŸ¥
  const taxIdPattern = /^\d{8}$/;
  if (!taxIdPattern.test(taxId)) {
    showMessage("çµ±ä¸€ç·¨è™Ÿéœ€ç‚º 8 ä½æ•¸å­—", false);
    document.getElementById("applyBtn").disabled = true;
    return;
  }

  try {
    setButtonLoading("applyBtn", true);
    const res = await fetch(`/api/check-taxid?taxId=${taxId}`, {
      credentials: "include"
    });
    
    if (!res.ok) {
      throw new Error('æª¢æŸ¥çµ±ç·¨å¤±æ•—');
    }
    
    const data = await res.json();
    if (data.exists) {
      showMessage("çµ±ä¸€ç·¨è™Ÿå·²è¢«ä½¿ç”¨ï¼Œè«‹ç¢ºèª", false);
      document.getElementById("applyBtn").disabled = true;
    } else {
      showMessage("çµ±ç·¨å¯ç”¨", true);
      document.getElementById("applyBtn").disabled = false;
    }
  } catch (err) {
    showMessage("çµ±ç·¨æª¢æŸ¥æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨", false);
    document.getElementById("applyBtn").disabled = false;
  } finally {
    setButtonLoading("applyBtn", false);
  }
});

// ============================================
// 1ï¸âƒ£2ï¸âƒ£ çµ„ç¹”é¡å‹èˆ‡è·ä½å°æ‡‰
// ============================================

const positionMap = {
  logistics: [
    { value: "LogisticsRootAdmin", text: "ç‰©æµè² è²¬äºº" }
  ],
  retail: [
    { value: "CommunityAdmin", text: "ç¤¾å€ç®¡ç†å“¡" }
  ]
};

document.getElementById("orgType").addEventListener("change", () => {
  const orgType = document.getElementById("orgType").value;
  const positionSelect = document.getElementById("position");

  positionSelect.innerHTML = "";

  positionMap[orgType].forEach(pos => {
    const opt = document.createElement("option");
    opt.value = pos.value;
    opt.textContent = pos.text;
    positionSelect.appendChild(opt);
  });
});

// åˆå§‹åŒ–ä¸€æ¬¡
document.getElementById("orgType").dispatchEvent(new Event("change"));

// ============================================
// 1ï¸âƒ£3ï¸âƒ£ é€å‡ºç‰©æµçµ„ç¹”ç”³è«‹ï¼ˆä¸»è¦ä¿®æ”¹é»ï¼‰
// ============================================

document.getElementById("applyBtn").onclick = async () => {
  preventDoubleSubmit("applyOrg", async () => {
    const taxId = document.getElementById("taxId").value.trim();
    const name = document.getElementById("orgName").value.trim();
    const address = document.getElementById("orgAddress").value.trim();
    const position = document.getElementById("position").value.trim();
    const type = document.getElementById("orgType").value;

    if (!userEmail) {
      showMessage("ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Šï¼Œè«‹é‡æ–°ç™»å…¥", false);
      return;
    }
    if (!taxId || !name || !position || !address) {
      showMessage("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½", false);
      return;
    }

    // çµ±ç·¨æ ¼å¼æª¢æŸ¥
    const taxIdPattern = /^\d{8}$/;
    if (!taxIdPattern.test(taxId)) {
      showMessage("çµ±ä¸€ç·¨è™Ÿéœ€ç‚º 8 ä½æ•¸å­—", false);
      return;
    }

    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    setButtonLoading("applyBtn", true);
    showGlobalLoading("æ­£åœ¨é€å‡ºç”³è«‹...è³‡æ–™å¯«å…¥ä¸­");

    try {
      const res = await fetch("/api/apply-logistics", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({
          email: userEmail,
          orgName: name,
          orgType: type,
          position,
          taxId,
          address
        })
      });

      let data;
      try {
        data = await res.json();
      } catch(e) {
        console.warn("âš  ç„¡æ³•è§£æ JSONï¼Œä½†ç‹€æ…‹æˆåŠŸ");
        data = {};
      }

      if (res.ok) {
        showMessage("âœ… ç”³è«‹é€å‡ºæˆåŠŸï¼è«‹ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸", true);
        
        // é¡¯ç¤ºã€Œå¯©æ ¸ä¸­ã€
        document.getElementById("applicationStatus").classList.remove("hidden");
        
        // éš±è—ç”³è«‹è¡¨å–®ï¼Œé¡¯ç¤ºæŒ‰éˆ•
        document.getElementById("applyOrgDiv").classList.add("hidden");
        showAllButtons();
        
        clearApplyForm();
        
        // é‡æ–°è¼‰å…¥çµ„ç¹”æ¸…å–®
        setTimeout(() => {
          loadOrganizations();
        }, 1000);
      } 
    } catch (err) {
  
    } finally {
      setButtonLoading("applyBtn", false);
      hideGlobalLoading();
    }
  });
};

// ============================================
// ğŸ”§ è¼”åŠ©å‡½å¼
// ============================================

function clearApplyForm() {
  document.getElementById("taxId").value = "";
  document.getElementById("orgName").value = "";
  document.getElementById("orgAddress").value = "";
}

function showMessage(msg, success = false) {
  const div = document.getElementById("message");
  
  if (!msg) {
    div.style.display = "none";
    return;
  }
  
  div.style.display = "block";
  div.className = success ? "success" : "";
  div.textContent = msg;
  
  // æˆåŠŸè¨Šæ¯3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
  if (success) {
    setTimeout(() => {
      div.style.display = "none";
    }, 5000);
  }
}

function addRoleOption(select, text) {
  const opt = document.createElement("option");
  opt.value = text;
  opt.textContent = text;
  select.appendChild(opt);
}

// ============================================
// ğŸ“± é é¢è¼‰å…¥åˆå§‹åŒ–
// ============================================

document.addEventListener("DOMContentLoaded", () => {
  console.log("ğŸš€ é é¢è¼‰å…¥å®Œæˆ");
  
  // å…ˆè¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
  loadPersonEmail().then(() => {
    // ç„¶å¾Œè¼‰å…¥çµ„ç¹”
    loadOrganizations();
  });
  
  // åˆå§‹é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  setTimeout(() => {
    hideGlobalLoading();
  }, 500);
});
</script>
</body>
</html>